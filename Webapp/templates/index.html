<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>LTP Dashboard</title>
    <style>
      :root {
        --blue-900: #0a2540;
        --blue-700: #1e3a8a;
        --blue-600: #2563eb;
        --blue-100: #eaf2ff;
        --blue-050: #f5f8ff;
        --white: #ffffff;
        --border: #d9e2f1;
        --text: #0f172a;
        --muted: #5b6b86;
        --success: #0a7d34;
        --danger: #b00020;
      }
      body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif; margin: 24px; color: var(--text); background: var(--blue-050); }
      .header { display:flex; align-items:center; justify-content:space-between; margin-bottom: 16px; }
      h1 { font-size: 22px; margin: 0; color: var(--blue-900); }
      #meta { font-size: 13px; margin-left: 8px; color: var(--muted); }

      .card { background: var(--white); border: 1px solid var(--border); border-radius: 10px; box-shadow: 0 2px 6px rgba(10,37,64,0.06); }
      .card-header { padding: 12px 16px; border-bottom: 1px solid var(--border); background: var(--blue-100); }
      .card-body { padding: 12px 16px; }

      .btn-row { margin-bottom: 12px; }
      .btn { padding: 8px 12px; margin-right: 6px; cursor: pointer; border: 1px solid var(--blue-600); color: var(--white); background: var(--blue-600); border-radius: 6px; font-weight: 600; }
      .btn.secondary { color: var(--blue-700); background: var(--white); border-color: var(--blue-700); }
  .btn.active { color: var(--white); background: var(--blue-600); border-color: var(--blue-600); }
      .btn:hover { filter: brightness(1.05); }
  .btn.small { padding: 4px 8px; font-size: 12px; }

      table { border-collapse: collapse; width: 100%; }
      th, td { border: 1px solid var(--border); padding: 8px; font-size: 14px; }
      th { background: var(--blue-100); text-align: left; color: var(--blue-900); }
      tbody tr:nth-child(even) { background: var(--blue-050); }
      tbody tr:hover { background: #eef4ff; }

      .badge { display:inline-block; padding: 2px 8px; border-radius: 999px; font-size: 12px; font-weight: 600; }
      .badge.rank { background: #e9f0ff; color: var(--blue-700); border: 1px solid var(--border); }
  .num { font-weight: 600; }
      .muted { color: var(--muted); }
      #error { color: var(--danger); margin-bottom: 8px; }
    </style>
  </head>
  <body>
    <div class="header">
      <h1>LTP Dashboard <span id="meta" class="muted"></span></h1>
      <div class="btn-row">
        <button class="btn" onclick="downloadCSV()">Download CSV</button>
        <button class="btn secondary" onclick="manualRefresh()">Refresh Now</button>
      </div>
    </div>
    <div id="error"></div>

    <!-- Tabs -->
    <div class="btn-row" style="margin-top:-4px;">
  <button id="tab-main" class="btn secondary">All</button>
  <button id="tab-filtered" class="btn secondary">Filtered</button>
    <button id="tab-ck" class="btn secondary">CK</button>
    <button id="tab-futures" class="btn secondary">Futures</button>
  <button id="tab-vcp" class="btn secondary">VCP</button>
  <button id="tab-ema-history" class="btn secondary">EMA History (15m)</button>
  <button id="tab-orders" class="btn secondary">Orders</button>
  <button id="tab-active" class="btn secondary">Active Orderbook</button>
  <button id="tab-trades" class="btn secondary">Trade Journal</button>
    </div>

    <!-- Main view -->
    <div id="view-main" class="card">
      <div class="card-header" style="display:flex;align-items:center;justify-content:space-between;">
        <span>Live Stock Metrics</span>
        <button id="btn-show-filtered" class="btn secondary">Filter</button>
      </div>
      <div class="card-body">
    <table id="ltp-table">
      <thead>
        <tr>
          <th data-key="symbol">Symbol</th>
          <th data-key="rank_gm">Rank (GM)</th>
          <th data-key="drawdown_15m_200_pct">Drawdown</th>
          <th data-key="pullback_15m_200_pct">Pullback</th>
          <th data-key="days_since_golden_cross">Days Since Crossover</th>
          <th data-key="last_price">Last Price</th>
          <th data-key="last_close">Last Close (15m)</th>
          <th data-key="pct_vs_15m_sma50">% vs 15m SMA50</th>
          <th data-key="ratio_15m_50_200">15m 50/200 Ratio</th>
          <th data-key="pct_vs_daily_sma20">% vs Daily SMA20</th>
          <th data-key="daily_ratio_50_200">Daily 50/200 Ratio</th>
          <th>Supports</th>
          <th>Resistances</th>
          <th data-key="volume_ratio_d5_d200">Volume Ratio</th>
          <th>Buy + SL 5% (₹10k)</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
      </div>
    </div>

      <!-- CK view -->
      <div id="view-ck" class="card" style="display:none; margin-top:14px;">
        <div class="card-header">CK - RSI (15m)</div>
        <div class="card-body">
          <!-- Sub-tabs for CK -->
          <div class="btn-row" style="margin-bottom:12px;">
            <button id="ck-subtab-momentum" class="btn small active">Momentum</button>
            <button id="ck-subtab-reversals" class="btn small secondary">Reversals at Levels</button>
            <button id="ck-subtab-averages" class="btn small secondary">Averages</button>
            <button id="ck-subtab-strategy" class="btn small secondary">Strategy</button>
          </div>

          <!-- Momentum sub-view -->
          <div id="ck-view-momentum">
            <table id="ck-table-momentum">
              <thead>
                <tr>
                  <th data-key="symbol">Symbol</th>
                  <th data-key="rank_gm">Rank (GM)</th>
                  <th data-key="last_price">Last Price</th>
                  <th data-key="rsi_15m">RSI (15m)</th>
                  <th data-key="local_30d_low">Local 30d Low <br>(% above the low)</th>
                  <th data-key="local_30d_high">Local 30d High<br>(% below the high)</th>
                  <th data-key="trading_zone_pct">Trading Zone %</th>
                  <th data-key="signal">Signal</th>
                  <th data-key="action">Action</th>
                  <th>Buy + SL 5% (₹10k)</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>

          <!-- Reversals at Levels sub-view -->
          <div id="ck-view-reversals" style="display:none;">
            <table id="ck-table-reversals">
              <thead>
                <tr>
                  <th data-key="symbol">Symbol</th>
                  <th data-key="rank_gm">Rank (GM)</th>
                  <th>User Support</th>
                  <th data-key="last_price">Last Price</th>
                  <th data-key="rsi_15m">RSI (15m)</th>
                  <th>Major Support</th>
                  <th data-key="local_30d_low">Local 30d Low <br>(% above the low)</th>
                  <th data-key="local_30d_high">Local 30d High<br>(% below the high)</th>
                  <th data-key="trading_zone_pct">Trading Zone %</th>
                  <th data-key="signal">Signal</th>
                  <th data-key="action">Action</th>
                  <th>Buy + SL 5% (₹10k)</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
          <!-- Averages sub-view -->
          <div id="ck-view-averages" style="display:none;">
            <table id="ck-table-averages">
              <thead>
                <tr>
                  <th data-key="symbol">Symbol</th>
                  <th data-key="last_price">Last Price</th>
                  <th data-key="ema_signal">Uptrend Confirm</th>
                  <th data-key="ema5">EMA 5d</th>
                  <th data-key="ema8">EMA 8d</th>
                  <th data-key="ema10">EMA 10d</th>
                  <th data-key="ema20">EMA 20d</th>
                  <th data-key="ema50">EMA 50d</th>
                  <th data-key="ema100">EMA 100d</th>
                  <th data-key="ema200">EMA 200d</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>

          <!-- Strategy sub-view -->
          <div id="ck-view-strategy" style="display:none;">
            <!-- Strategy Control Panel -->
            <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:16px; padding:12px; background:#f8fafc; border-radius:8px; border:1px solid #e2e8f0;">
              <div style="display:flex; align-items:center; gap:16px;">
                <div>
                  <span style="font-weight:600; color:#1e293b;">Momentum Strategy</span>
                  <span id="strategy-status-badge" class="badge" style="margin-left:8px; background:#ef4444; color:white;">STOPPED</span>
                </div>
                <div style="font-size:13px; color:#64748b;">
                  Per Position: ₹<span id="strategy-per-position">5,000</span> | 
                  Positions: <span id="strategy-positions">0</span>/<span id="strategy-max-positions">20</span> |
                  Today's PnL: ₹<span id="strategy-pnl-today" style="font-weight:600;">0</span>
                </div>
                <div id="strategy-timer-container" style="display:none; font-size:13px; padding:4px 10px; background:#fef3c7; border-radius:6px; border:1px solid #fcd34d;">
                  <span style="color:#92400e;">⏱ Next scan in: </span>
                  <span id="strategy-next-scan" style="font-weight:700; color:#b45309;">60s</span>
                </div>
              </div>
              <div style="display:flex; align-items:center; gap:12px;">
                <!-- PAPER/LIVE Mode Toggle -->
                <div style="display:flex; align-items:center; gap:8px; padding:6px 8px; background:#f1f5f9; border-radius:6px; border:1px solid #e2e8f0;">
                  <span style="font-size:12px; color:#64748b; font-weight:600;">Mode:</span>
                  <button id="btn-mode-paper" class="btn small" onclick="selectMode('PAPER')" style="background:#ef4444; border-color:#ef4444; padding:4px 10px;">
                    PAPER
                  </button>
                  <button id="btn-mode-live" class="btn small secondary" onclick="selectMode('LIVE')" style="padding:4px 10px; color:#dc2626; border-color:#fca5a5;">
                    LIVE
                  </button>
                </div>
                <button id="btn-strategy-start" class="btn" onclick="startStrategy()" style="background:#22c55e; border-color:#22c55e;">
                  ▶ Start Strategy
                </button>
                <button id="btn-strategy-stop" class="btn" onclick="stopStrategy()" style="background:#ef4444; border-color:#ef4444; display:none;">
                  ■ Stop Strategy
                </button>
                <button id="btn-close-all" class="btn" onclick="closeAllPositions()" style="background:#9333ea; border-color:#9333ea;" title="Close all open positions">
                  ✕ Close All
                </button>
              </div>
            </div>

            <!-- Capital Summary Panel -->
            <div style="display:grid; grid-template-columns:repeat(4, 1fr); gap:12px; margin-bottom:16px;">
              <div style="padding:12px; background:#f0fdf4; border-radius:8px; border:1px solid #bbf7d0; text-align:center;">
                <div style="font-size:12px; color:#15803d; margin-bottom:4px;">Total Capital</div>
                <div style="font-size:18px; font-weight:700; color:#166534;">₹<span id="strategy-total-capital">100,000</span></div>
              </div>
              <div style="padding:12px; background:#eff6ff; border-radius:8px; border:1px solid #bfdbfe; text-align:center;">
                <div style="font-size:12px; color:#1d4ed8; margin-bottom:4px;">Deployed Capital</div>
                <div style="font-size:18px; font-weight:700; color:#1e40af;">₹<span id="strategy-deployed-capital">0</span></div>
              </div>
              <div style="padding:12px; background:#fefce8; border-radius:8px; border:1px solid #fef08a; text-align:center;">
                <div style="font-size:12px; color:#a16207; margin-bottom:4px;">Current Value</div>
                <div style="font-size:18px; font-weight:700; color:#a16207;">₹<span id="strategy-current-value">0</span></div>
              </div>
              <div style="padding:12px; background:#faf5ff; border-radius:8px; border:1px solid #e9d5ff; text-align:center;">
                <div style="font-size:12px; color:#7c3aed; margin-bottom:4px;">Unrealized PnL</div>
                <div style="font-size:18px; font-weight:700;" id="strategy-unrealized-pnl-container"><span id="strategy-unrealized-pnl">₹0</span></div>
              </div>
            </div>

            <!-- Strategy Rules Summary -->
            <div style="margin-bottom:16px; padding:12px; background:#eff6ff; border-radius:8px; border:1px solid #bfdbfe; font-size:13px;">
              <div style="font-weight:600; color:#1e40af; margin-bottom:8px;">Position Ladder Rules:</div>
              <div style="display:grid; grid-template-columns:repeat(3, 1fr); gap:12px;">
                <div style="padding:8px; background:white; border-radius:6px; border:1px solid #dbeafe;">
                  <div style="font-weight:600; color:#1e40af;">Position 1 <span id="p1-badge" style="font-weight:700; color:#dc2626; background:#fee2e2; padding:2px 6px; border-radius:4px; font-size:12px;">0</span></div>
                  <div style="color:#475569;" id="p1-entry">Entry: No active positions</div>
                  <div style="color:#dc2626;" id="p1-sl">SL: -2.5% (fixed)</div>
                  <div style="color:#16a34a;" id="p1-target">Target: +5%</div>
                </div>
                <div style="padding:8px; background:white; border-radius:6px; border:1px solid #dbeafe;">
                  <div style="font-weight:600; color:#1e40af;">Position 2 <span id="p2-badge" style="font-weight:700; color:#dc2626; background:#fee2e2; padding:2px 6px; border-radius:4px; font-size:12px;">0</span></div>
                  <div style="color:#475569;" id="p2-entry">Entry: P1 PnL > 0.25%</div>
                  <div style="color:#dc2626;" id="p2-sl">SL: -2.5% (trailing)</div>
                  <div style="color:#16a34a;" id="p2-target">Target: Runner</div>
                </div>
                <div style="padding:8px; background:white; border-radius:6px; border:1px solid #dbeafe;">
                  <div style="font-weight:600; color:#1e40af;">Position 3 <span id="p3-badge" style="font-weight:700; color:#dc2626; background:#fee2e2; padding:2px 6px; border-radius:4px; font-size:12px;">0</span></div>
                  <div style="color:#475569;" id="p3-entry">Entry: Avg(P1,P2) ≥ +1%</div>
                  <div style="color:#dc2626;" id="p3-sl">SL: -5% (trailing)</div>
                  <div style="color:#16a34a;" id="p3-target">Target: Runner</div>
                </div>
              </div>
            </div>

            <!-- Open Positions Table -->
            <div style="margin-bottom:16px;">
              <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:12px;">
                <div style="font-weight:600; color:#1e293b;">Open Positions</div>
                <div style="display:flex; align-items:center; gap:16px; padding:8px 12px; background:#f0f9ff; border-radius:6px; border:1px solid #bfdbfe;">
                  <span style="font-size:13px; color:#0c4a6e;">Net PnL (Today):</span>
                  <span id="strategy-net-pnl" style="font-size:16px; font-weight:700; color:#0c4a6e;">₹0</span>
                </div>
              </div>
              <table id="strategy-open-table">
                <thead>
                  <tr>
                    <th data-key="position_number">Position</th>
                    <th data-key="symbol">Symbol</th>
                    <th data-key="entry_time">Entry Time</th>
                    <th data-key="entry_price">Entry Price</th>
                    <th data-key="qty">Qty</th>
                    <th data-key="ltp">LTP</th>
                    <th data-key="stop_loss">Stop Loss</th>
                    <th data-key="target">Target</th>
                    <th data-key="current_pnl_pct">PnL %</th>
                    <th data-key="current_pnl_inr">PnL ₹</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody id="strategy-open-tbody">
                  <tr><td colspan="11" style="text-align:center; color:#94a3b8; padding:20px;">No open positions</td></tr>
                </tbody>
              </table>
            </div>

            <!-- Today's Closed Trades Table -->
            <div>
              <div style="font-weight:600; color:#1e293b; margin-bottom:8px;">Today's Closed Trades</div>
              <table id="strategy-closed-table">
                <thead>
                  <tr>
                    <th>Position</th>
                    <th>Symbol</th>
                    <th>Entry Time</th>
                    <th>Entry Price</th>
                    <th>Exit Time</th>
                    <th>Exit Price</th>
                    <th>Qty</th>
                    <th>PnL ₹</th>
                  </tr>
                </thead>
                <tbody id="strategy-closed-tbody">
                  <tr><td colspan="8" style="text-align:center; color:#94a3b8; padding:20px;">No closed trades today</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

    <!-- Futures view -->
    <div id="view-futures" class="card" style="display:none; margin-top:14px;">
      <div class="card-header">Futures - Front Contracts RSI (15m)</div>
      <div class="card-body">
        <!-- Sub-tabs for Futures (similar to CK) -->
        <div class="btn-row" style="margin-bottom:12px;">
          <button id="futures-subtab-momentum" class="btn small active">Momentum</button>
          <button id="futures-subtab-reversals" class="btn small secondary">Reversals at Levels</button>
          <button id="futures-subtab-strategy" class="btn small secondary">Strategy</button>
        </div>

        <!-- Futures Momentum sub-view -->
        <div id="futures-view-momentum">
          <table id="futures-table-momentum">
            <thead>
              <tr>
                <th data-key="symbol">Symbol (Front Contract)</th>
                <th data-key="expiry">Expiry</th>
                <th data-key="last_price">Last Price</th>
                <th data-key="rsi_15m">RSI (15m)</th>
                <th data-key="sma50_15m">SMA50 (15m)</th>
                <th data-key="sma200_15m">SMA200 (15m)</th>
                <th data-key="pct_vs_15m_sma50">% vs SMA50</th>
                <th data-key="signal">Signal</th>
                <th data-key="action">Action</th>
                <th>Buy + SL 5% (₹10k)</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <!-- Futures Reversals sub-view -->
        <div id="futures-view-reversals" style="display:none;">
          <table id="futures-table-reversals">
            <thead>
              <tr>
                <th data-key="symbol">Symbol (Front Contract)</th>
                <th data-key="expiry">Expiry</th>
                <th data-key="last_price">Last Price</th>
                <th data-key="rsi_15m">RSI (15m)</th>
                <th data-key="sma50_15m">SMA50 (15m)</th>
                <th data-key="sma200_15m">SMA200 (15m)</th>
                <th data-key="signal">Signal</th>
                <th data-key="action">Action</th>
                <th>Buy + SL 5% (₹10k)</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <!-- Futures Strategy sub-view (inherits from CK strategy panel) -->
        <div id="futures-view-strategy" style="display:none;">
          <div style="padding:12px; background:#f0fdf4; border-radius:8px; border:1px solid #bbf7d0; margin-bottom:16px;">
            <div style="font-size:13px; color:#15803d;">
              <strong>Note:</strong> Futures trading shares the same Momentum Strategy as the main CK tab. 
              The futures tab displays front contracts with technical analysis only.
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- VCP view -->
    <div id="view-vcp" class="card" style="display:none; margin-top:14px;">
      <div class="card-header" style="display:flex;align-items:center;justify-content:space-between;">
        <span>VCP Breakout Patterns (15m Data)</span>
        <div style="display:flex; gap:10px; align-items:center; font-size:12px;">
          <span class="muted">Mark Minervini Style - EMA50 Trend + ATR + Volume</span>
        </div>
      </div>
      <div class="card-body">
        <table id="vcp-table">
          <thead>
            <tr>
              <th data-key="symbol">Symbol</th>
              <th data-key="pattern_stage">Pattern Stage</th>
              <th data-key="entry_signal">Entry Signal</th>
              <th data-key="confidence_score">Confidence</th>
              <th data-key="last_price">Current Price</th>
              <th data-key="entry_price">Entry Price</th>
              <th data-key="stop_loss">Stop Loss</th>
              <th data-key="target">Target (3R)</th>
              <th data-key="distance">Distance (%)</th>
              <th data-key="breakout_level">Breakout Level</th>
              <th data-key="num_contractions">Contractions</th>
              <th data-key="volatility_trend">Vol Trend</th>
              <th data-key="signal">CK Signal</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- Filtered view -->
    <div id="view-filtered" class="card" style="display:none; margin-top:14px;">
      <div class="card-header">Filtered Metrics</div>
      <div class="card-body">
        <div style="display:flex; flex-wrap:wrap; gap:12px; align-items:flex-end; margin-bottom:10px;">
          <div>
            <div class="muted" style="font-size:12px;">Rank (GM) min</div>
            <input id="f-rank-min" type="number" step="0.01" placeholder="min" style="padding:6px; width:120px;" />
          </div>
          <div>
            <div class="muted" style="font-size:12px;">Rank (GM) max</div>
            <input id="f-rank-max" type="number" step="0.01" placeholder="max" style="padding:6px; width:120px;" />
          </div>
          <div>
            <div class="muted" style="font-size:12px;">15m 50/200 Ratio min</div>
            <input id="f-r15-min" type="number" step="0.01" placeholder="min" style="padding:6px; width:140px;" />
          </div>
          <div>
            <div class="muted" style="font-size:12px;">15m 50/200 Ratio max</div>
            <input id="f-r15-max" type="number" step="0.01" placeholder="max" style="padding:6px; width:140px;" />
          </div>
          <div>
            <div class="muted" style="font-size:12px;">Daily 50/200 Ratio min</div>
            <input id="f-rd-min" type="number" step="0.01" placeholder="min" style="padding:6px; width:140px;" />
          </div>
          <div>
            <div class="muted" style="font-size:12px;">Daily 50/200 Ratio max</div>
            <input id="f-rd-max" type="number" step="0.01" placeholder="max" style="padding:6px; width:140px;" />
          </div>
          <div>
            <div class="muted" style="font-size:12px;">Drawdown min</div>
            <input id="f-dd-min" type="number" step="0.01" placeholder="min" style="padding:6px; width:120px;" />
          </div>
          <div>
            <div class="muted" style="font-size:12px;">Drawdown max</div>
            <input id="f-dd-max" type="number" step="0.01" placeholder="max" style="padding:6px; width:120px;" />
          </div>
          <div>
            <button class="btn" id="apply-filters">Apply Filters</button>
            <button class="btn secondary" id="reset-filters" style="margin-left:6px;">Reset</button>
          </div>
        </div>
        <table id="ltp-table-filtered">
          <thead>
            <tr>
              <th data-key="symbol">Symbol</th>
              <th data-key="rank_gm">Rank (GM)</th>
              <th data-key="drawdown_15m_200_pct">Drawdown</th>
              <th data-key="pullback_15m_200_pct">Pullback</th>
              <th data-key="days_since_golden_cross">Days Since Crossover</th>
              <th data-key="last_price">Last Price</th>
              <th data-key="last_close">Last Close (15m)</th>
              <th data-key="pct_vs_15m_sma50">% vs 15m SMA50</th>
              <th data-key="ratio_15m_50_200">15m 50/200 Ratio</th>
              <th data-key="pct_vs_daily_sma20">% vs Daily SMA20</th>
              <th data-key="daily_ratio_50_200">Daily 50/200 Ratio</th>
              <th>Supports</th>
              <th>Resistances</th>
              <th data-key="volume_ratio_d5_d200">Volume Ratio</th>
              <th>Buy + SL 5% (₹10k)</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
    <!-- Active Orderbook view -->
    <div id="view-active" class="card" style="display:none; margin-top:14px;">
      <div class="card-header" style="display:flex;align-items:center;justify-content:space-between;">
        <span>Active Orderbook (Broker) & GTTs</span>
        <div style="display:flex; gap:10px; align-items:center;">
          <button class="btn secondary" id="btn-refresh-active">Refresh</button>
        </div>
      </div>
      <div class="card-body">
        <div style="margin-bottom:10px; font-weight:600;">Active Orders</div>
        <table id="active-orders-table">
          <thead>
            <tr>
              <th data-key="symbol">Symbol</th>
              <th data-key="order_id">Order ID</th>
              <th data-key="qty">Qty</th>
              <th data-key="price">Price</th>
              <th data-key="ltp">LTP</th>
              <th data-key="status">Status</th>
              <th data-key="type">Type</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <div style="height:12px"></div>
        <div style="margin-bottom:10px; font-weight:600;">GTT Orders</div>
        <table id="active-gtt-table">
          <thead>
            <tr>
              <th data-key="symbol">Symbol</th>
              <th data-key="gtt_id">GTT ID</th>
              <th data-key="qty">Qty</th>
              <th data-key="ltp">LTP</th>
              <th data-key="stop">Stop</th>
              <th data-key="target">Target</th>
              <th data-key="type">Type</th>
              <th data-key="status">Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- EMA History (15m) view -->
    <div id="view-ema-history" class="card" style="display:none; margin-top:14px;">
      <div class="card-header" style="display:flex;align-items:center;justify-content:space-between;">
        <span>EMA History (15-Minute Candles)</span>
        <div style="display:flex; gap:10px; align-items:center;">
          <input id="ema-filter-symbol" type="text" placeholder="Filter by symbol..." style="padding:6px; width:150px;" />
          <button class="btn secondary" id="btn-refresh-ema-history">Refresh</button>
        </div>
      </div>
      <div class="card-body">
        <table id="ema-history-table">
          <thead>
            <tr>
              <th data-key="timestamp">Timestamp</th>
              <th data-key="symbol">Symbol</th>
              <th data-key="ema_20">EMA 20</th>
              <th data-key="ema_50">EMA 50</th>
              <th data-key="ema_100">EMA 100</th>
              <th data-key="ema_200">EMA 200</th>
              <th data-key="ltp">Last Traded Price</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- Orders view -->
    <div id="view-orders" class="card" style="display:none; margin-top:14px;">
      <div class="card-header" style="display:flex;align-items:center;justify-content:space-between;">
        <span>Orders placed via Webapp <span id="orders-meta" class="muted"></span></span>
        <div style="display:flex; gap:10px; align-items:center;">
          <span class="muted" id="bracket-params">Bracket: Target +7.5% / Stop -5% (Trailing on)</span>
          <button class="btn secondary" id="btn-refresh-orders">Refresh</button>
        </div>
      </div>
      <div class="card-body">
  <table id="orders-table">
          <thead>
            <tr>
              <th data-key="symbol">Symbol</th>
              <th data-key="quantity">Qty</th>
              <th data-key="status">Status</th>
              <th data-key="avg_price">Avg/Entry</th>
              <th data-key="ltp">LTP</th>
              <th data-key="trail_trigger">Trailing Stop</th>
              <th data-key="gtt_stop_price">Stop (GTT)</th>
              <th data-key="gtt_stop_pct_from_ltp">Stop % from LTP</th>
              <th data-key="gtt_target_price">Target (GTT)</th>
              <th data-key="gtt_target_pct_from_ltp">Target % from LTP</th>
              <th data-key="pnl">PnL (₹)</th>
              <th data-key="pnl_pct">PnL %</th>
        <th data-key="order_id">Order ID</th>
        <th data-key="gtt_id">GTT ID</th>
        <th data-key="actions">Actions</th>
      <th data-key="total_pnl">Total PnL (₹)</th>
            </tr>
          </thead>
          <tbody></tbody>
          <tfoot>
            <tr>
              <td colspan="12" style="text-align:right; font-weight:600;">Total PnL:</td>
              <td id="orders-total-pnl-cell" class="num"></td>
            </tr>
          </tfoot>
        </table>
        <div id="orders-total-pnl" class="num" style="margin-top:6px; font-size:14px;"></div>
        <div style="margin-top:12px; display:flex; align-items:center; justify-content:space-between;">
          <div class="muted">Consolidated (Holdings / Positions / Active Orders / Trades / GTT)</div>
        </div>
        <table id="orders-snapshot" style="margin-top:6px;">
          <thead>
            <tr>
              <th data-key="symbol">Symbol</th>
              <th data-key="total_holdings">Total Holdings (₹) | Pos Qty</th>
              <th data-key="total_amount">Total Amount (₹)</th>
              <th data-key="holding_qty">Holding Qty</th>
              <th data-key="holding_avg">Holding Avg</th>
              <th data-key="holding_ltp">Holding LTP</th>
              <th data-key="holding_pnl">Holding PnL</th>
              <th data-key="position_qty">Position Qty (net)</th>
              <th data-key="position_pnl_day">Position PnL (day)</th>
              <th data-key="active_orders">Active Orders</th>
              <th data-key="trades_count">Trades (count)</th>
              <th data-key="gtt_count">GTT (count)</th>
              <th data-key="gtt_triggers">GTT Triggers</th>
              <th data-key="combined_pnl">Combined PnL (₹)</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- Trade Journal view -->
    <div id="view-trades" class="card" style="display:none; margin-top:14px;">
      <div class="card-header" style="display:flex;align-items:center;justify-content:space-between;">
        <span>Trade Journal <span id="trades-meta" class="muted"></span></span>
        <div style="display:flex; gap:10px; align-items:center;">
          <button class="btn secondary" id="btn-sync-exits" title="Sync open trades and log exits">Sync Exits</button>
          <button class="btn secondary" id="btn-refresh-trades">Refresh</button>
          <button class="btn secondary" id="btn-export-trades">Export CSV</button>
        </div>
      </div>
      <div class="card-body">
        <div style="display:flex; flex-wrap:wrap; gap:12px; align-items:flex-end; margin-bottom:10px;">
          <div>
            <div class="muted" style="font-size:12px;">Filter by Symbol</div>
            <input id="tj-filter-symbol" type="text" placeholder="e.g., INFY" style="padding:6px; width:120px;" />
          </div>
          <div>
            <div class="muted" style="font-size:12px;">Date Range (From)</div>
            <input id="tj-filter-date-from" type="date" style="padding:6px; width:140px;" />
          </div>
          <div>
            <div class="muted" style="font-size:12px;">Date Range (To)</div>
            <input id="tj-filter-date-to" type="date" style="padding:6px; width:140px;" />
          </div>
          <div>
            <button class="btn" id="tj-apply-filters">Apply Filters</button>
            <button class="btn secondary" id="tj-reset-filters" style="margin-left:6px;">Reset</button>
          </div>
        </div>
        <table id="trades-table">
          <thead>
            <tr>
              <th data-key="symbol">Symbol</th>
              <th data-key="entry_date">Entry Date</th>
              <th data-key="entry_price">Entry Price</th>
              <th data-key="entry_qty">Qty</th>
              <th data-key="exit_date">Exit Date</th>
              <th data-key="exit_price">Exit Price</th>
              <th data-key="pnl">PnL (₹)</th>
              <th data-key="pnl_pct">PnL %</th>
              <th data-key="duration">Duration (hrs)</th>
              <th data-key="strategy">Strategy</th>
              <th data-key="status">Status</th>
              <th data-key="notes">Notes</th>
            </tr>
          </thead>
          <tbody></tbody>
          <tfoot>
            <tr>
              <td colspan="6" style="text-align:right; font-weight:600;">Total PnL:</td>
              <td id="trades-total-pnl-cell" class="num"></td>
              <td id="trades-total-pnl-pct-cell" class="num"></td>
            </tr>
          </tfoot>
        </table>
        <div id="trades-summary" style="margin-top:12px; display:flex; gap:20px; font-size:13px;">
          <div><span class="muted">Win Rate:</span> <span id="trades-winrate" class="num">-</span></div>
          <div><span class="muted">Avg Win:</span> <span id="trades-avg-win" class="num">-</span></div>
          <div><span class="muted">Avg Loss:</span> <span id="trades-avg-loss" class="num">-</span></div>
          <div><span class="muted">Profit Factor:</span> <span id="trades-profit-factor" class="num">-</span></div>
        </div>
      </div>
    </div>

    <script>
      // ============ XSS Security Helper Functions ============
      /**
       * Escapes HTML special characters to prevent XSS attacks.
       * Use when inserting user/API data into HTML via innerHTML.
       */
      function escapeHtml(text) {
        if (typeof text !== 'string') {
          return String(text);
        }
        const map = {
          '&': '&amp;',
          '<': '&lt;',
          '>': '&gt;',
          '"': '&quot;',
          "'": '&#x27;',
          '/': '&#x2F;'
        };
        return text.replace(/[&<>"'\/]/g, (char) => map[char]);
      }

      /**
       * Safely creates an element and sets text content to avoid XSS.
       * Preferred over innerHTML when inserting user/API data.
       */
      function setElementText(element, text) {
        element.textContent = text;
        return element;
      }

      /**
       * Safely inserts HTML but escapes all data values.
       * Use as: safeInnerHTML(element, `<td>${escapeHtml(data)}</td><td>${escapeHtml(data2)}</td>`)
       */
      function safeInnerHTML(element, htmlString) {
        element.innerHTML = htmlString;
        return element;
      }

      // ============ Color Helper Functions ============
      // Map a numeric value to a green↔red color using HSL.
      // value in [min,max] -> hue in [0 (red), 120 (green)]
      function hueForValue(value, min, max){
        if (typeof value !== 'number' || isNaN(value) || max === min) return null;
        const clamped = Math.max(min, Math.min(max, value));
        const t = (clamped - min) / (max - min);
        const hue = 120 * t; // 0=red, 120=green
        return `hsl(${hue}, 70%, 38%)`;
      }
      // Percent gradient helper: default range -20%..+20%
      function pctColor(v, min=-20, max=20){ return hueForValue(v, min, max); }
      // Inverse percent (lower is greener), e.g., drawdown: range 0..20
      function inversePctColor(v, min=0, max=20){
        if (typeof v !== 'number' || isNaN(v) || max === min) return null;
        const clamped = Math.max(min, Math.min(max, v));
        const t = (max - clamped) / (max - min); // lower v => higher t (greener)
        const hue = 120 * t;
        return `hsl(${hue}, 70%, 38%)`;
      }

  let latestRows = [];
  let userSupportLevels = {};

  async function fetchLTP() {
        const err = document.getElementById('error');
        err.textContent = '';
        try {
          const res = await fetch('/api/ltp');
          const json = await res.json();
          if (!res.ok) throw new Error(json.error || 'Failed to fetch LTP');
          const tbody = document.querySelector('#ltp-table tbody');
          tbody.innerHTML = '';
          const data = json.data || {};
          const universe = json.universe;
          const meta = document.getElementById('meta');
          meta.textContent = `(${universe}, ${Object.keys(data).length} symbols)`;
          
          // Fetch user support levels
          userSupportLevels = await fetchUserSupport();
          
          const symbols = Object.keys(data).sort();
          const rows = symbols.map(s => {
            const d = data[s] || {};
            const lp = d.last_price;
            const lc = d.last_close;
            const pct = (typeof lp === 'number' && typeof lc === 'number' && lc) ? ((lp - lc) / lc * 100) : null;
      return {
              symbol: s,
              rank_gm: d.rank_gm,
              last_price: lp,
              last_close: lc,
              pct_change: pct,
              sma200_15m: d.sma200_15m, // hidden
              sma50_15m: d.sma50_15m,   // hidden
              ratio_15m_50_200: d.ratio_15m_50_200,
              pct_vs_15m_sma50: d.pct_vs_15m_sma50,
              pct_vs_daily_sma20: d.pct_vs_daily_sma20,
              drawdown_15m_200_pct: d.drawdown_15m_200_pct,
              pullback_15m_200_pct: d.pullback_15m_200_pct,
              days_since_golden_cross: d.days_since_golden_cross,
              daily_sma50: d.daily_sma50,   // hidden
              daily_sma200: d.daily_sma200, // hidden
              daily_ratio_50_200: d.daily_ratio_50_200,
              supports: d.supports,
              resistances: d.resistances,
              volume_ratio_d5_d200: d.volume_ratio_d5_d200
            };
          });
          latestRows = rows;
          renderMainTable();
          renderFilteredTable();
        } catch (e) {
          err.textContent = e.message;
        }
      }
      // r: row object, opts: { ddMin, ddMax, pbMin, pbMax } - optional per-column color ranges
      function rowHtml(r, opts){
        opts = opts || {};
        // Drawdown color: inversePctColor expects (value, min, max). We use absolute drawdown magnitude.
        const ddVal = (typeof r.drawdown_15m_200_pct === 'number') ? Math.abs(r.drawdown_15m_200_pct) : null;
        const ddMin = (typeof opts.ddMin === 'number') ? opts.ddMin : 0;
        const ddMax = (typeof opts.ddMax === 'number') ? opts.ddMax : 20;
        const ddColor = ddVal != null ? inversePctColor(ddVal, ddMin, ddMax) : '';
        // Pullback color: use pctColor with per-column min/max
        const pbVal = (typeof r.pullback_15m_200_pct === 'number') ? r.pullback_15m_200_pct : null;
        const pbMin = (typeof opts.pbMin === 'number') ? opts.pbMin : -20;
        const pbMax = (typeof opts.pbMax === 'number') ? opts.pbMax : 20;
        const pbColor = pbVal != null ? pctColor(pbVal, pbMin, pbMax) : '';
        
        // Prepare supports/resistances display (escaped for security)
        let sup = (r.supports && r.supports.length) ? r.supports.map(s => escapeHtml(String(s))).join(', ') : '';
        const userSup = userSupportLevels[r.symbol];
        if (userSup != null) sup = sup ? sup + ', ' + escapeHtml(String(userSup)) : escapeHtml(String(userSup));
        const resArr = (r.resistances && r.resistances.length) ? r.resistances.map(res => escapeHtml(String(res))).join(', ') : '';

        return `
          <td>${escapeHtml(r.symbol)}</td>
          <td><span class="badge rank">${r.rank_gm != null ? r.rank_gm.toFixed(2) : ''}</span></td>
          <td><span class="num" style="color:${ddColor}">${ddVal != null ? ddVal.toFixed(2) + '%' : ''}</span></td>
          <td><span class="num" style="color:${pbColor}">${pbVal != null ? pbVal.toFixed(2) + '%' : ''}</span></td>
          <td>${r.days_since_golden_cross != null ? r.days_since_golden_cross : ''}</td>
          <td>${fmtNum(r.last_price)}</td>
          <td>${fmtNum(r.last_close)}</td>
          <td><span class="num" style="color:${r.pct_vs_15m_sma50!=null? pctColor(r.pct_vs_15m_sma50) : ''}">${r.pct_vs_15m_sma50 != null ? r.pct_vs_15m_sma50.toFixed(2) + '%' : ''}</span></td>
          <td>${r.ratio_15m_50_200 != null ? r.ratio_15m_50_200.toFixed(2) : ''}</td>
          <td><span class="num" style="color:${r.pct_vs_daily_sma20!=null? pctColor(r.pct_vs_daily_sma20) : ''}">${r.pct_vs_daily_sma20 != null ? r.pct_vs_daily_sma20.toFixed(2) + '%' : ''}</span></td>
          <td>${r.daily_ratio_50_200 != null ? r.daily_ratio_50_200.toFixed(2) : ''}</td>
          <td>${sup}</td>
          <td>${resArr}</td>
          <td>${r.volume_ratio_d5_d200 != null ? r.volume_ratio_d5_d200.toFixed(2) : ''}</td>
          <td><button class="btn small" onclick="placeBuy('${escapeHtml(r.symbol)}', this)" ${typeof r.last_price==='number' ? '' : 'disabled'}>Buy</button></td>
        `;
      }

      function renderMainTable(){
        const tbody = document.querySelector('#ltp-table tbody');
        const rows = latestRows.slice();
        applySort(rows, sortStateMain);
        tbody.innerHTML = '';
        for (const r of rows){
          const tr = document.createElement('tr');
          tr.innerHTML = rowHtml(r);
          tbody.appendChild(tr);
        }
      }

      function getFilters(){
        const val = id => document.getElementById(id).value;
        const num = v => (v === '' || v == null) ? null : Number(v);
        return {
          rankMin: num(val('f-rank-min')),
          rankMax: num(val('f-rank-max')),
          r15Min: num(val('f-r15-min')),
          r15Max: num(val('f-r15-max')),
          rdMin: num(val('f-rd-min')),
          rdMax: num(val('f-rd-max')),
          ddMin: num(val('f-dd-min')),
          ddMax: num(val('f-dd-max')),
        };
      }

      function matchFilters(r, f){
        // rank
        if (f.rankMin != null && (r.rank_gm == null || r.rank_gm < f.rankMin)) return false;
        if (f.rankMax != null && (r.rank_gm == null || r.rank_gm > f.rankMax)) return false;
        // 15m ratio
        if (f.r15Min != null && (r.ratio_15m_50_200 == null || r.ratio_15m_50_200 < f.r15Min)) return false;
        if (f.r15Max != null && (r.ratio_15m_50_200 == null || r.ratio_15m_50_200 > f.r15Max)) return false;
        // daily ratio
        if (f.rdMin != null && (r.daily_ratio_50_200 == null || r.daily_ratio_50_200 < f.rdMin)) return false;
        if (f.rdMax != null && (r.daily_ratio_50_200 == null || r.daily_ratio_50_200 > f.rdMax)) return false;
        // drawdown (use absolute positive value)
        const ddAbs = (typeof r.drawdown_15m_200_pct === 'number') ? Math.abs(r.drawdown_15m_200_pct) : null;
        if (f.ddMin != null && (ddAbs == null || ddAbs < f.ddMin)) return false;
        if (f.ddMax != null && (ddAbs == null || ddAbs > f.ddMax)) return false;
        return true;
      }

      function renderFilteredTable(){
        const tbody = document.querySelector('#ltp-table-filtered tbody');
        const f = getFilters();
        const arr = latestRows.filter(r => matchFilters(r, f));
        applySort(arr, sortStateFiltered);
        tbody.innerHTML = '';
        // compute per-column ranges for visible rows
        let ddMin = Infinity, ddMax = -Infinity, pbMin = Infinity, pbMax = -Infinity;
        for (const r of arr){
          const dd = (typeof r.drawdown_15m_200_pct === 'number') ? Math.abs(r.drawdown_15m_200_pct) : null;
          const pb = (typeof r.pullback_15m_200_pct === 'number') ? r.pullback_15m_200_pct : null;
          if (dd != null){ ddMin = Math.min(ddMin, dd); ddMax = Math.max(ddMax, dd); }
          if (pb != null){ pbMin = Math.min(pbMin, pb); pbMax = Math.max(pbMax, pb); }
        }
        if (ddMin === Infinity) ddMin = 0;
        if (ddMax === -Infinity) ddMax = 20;
        if (pbMin === Infinity) pbMin = -20;
        if (pbMax === -Infinity) pbMax = 20;

        const opts = { ddMin, ddMax, pbMin, pbMax };
        for (const r of arr){
          const tr = document.createElement('tr');
          tr.innerHTML = rowHtml(r, opts);
          tbody.appendChild(tr);
        }
      }
      function fmtNum(v){ return (typeof v === 'number' && !isNaN(v)) ? v.toFixed(2) : ''; }
      function numSignClass(v){ if (typeof v !== 'number' || isNaN(v)) return ''; return v >= 0 ? 'pos' : 'neg'; }
      let sortStateMain = { key: 'symbol', dir: 'asc' };
      let sortStateFiltered = { key: 'symbol', dir: 'asc' };
      function applySort(arr, state){
        const { key, dir } = state;
        arr.sort((a,b)=>{
          const va = a[key];
          const vb = b[key];
          if (va == null && vb == null) return 0;
          if (va == null) return 1;
          if (vb == null) return -1;
          if (typeof va === 'number' && typeof vb === 'number') return dir==='asc'? va - vb : vb - va;
          return dir==='asc'? String(va).localeCompare(String(vb)) : String(vb).localeCompare(String(va));
        });
      }
      function attachSortingFor(tableId, state, renderFn){
        const ths = document.querySelectorAll(`#${tableId} th[data-key]`);
        ths.forEach(th=>{
          th.style.cursor='pointer';
          th.addEventListener('click', ()=>{
            const key = th.getAttribute('data-key');
            if (state.key === key){
              state.dir = state.dir === 'asc' ? 'desc' : 'asc';
            } else {
              state.key = key; state.dir = 'asc';
            }
            renderFn();
          });
        });
      }
      attachSortingFor('ltp-table', sortStateMain, renderMainTable);
      attachSortingFor('ltp-table-filtered', sortStateFiltered, renderFilteredTable);
      function manualRefresh(){ fetchLTP(); }
      function downloadCSV(){ window.location = '/export/ltp.csv'; }
      async function saveUserSupport(symbol, value){
        try {
          await fetch('/api/user-support', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ symbol, support_price: value ? parseFloat(value) : null })
          });
        } catch(e) {
          console.error('Failed to save user support:', e);
        }
      }
      
      async function fetchUserSupport(){
        try {
          const res = await fetch('/api/user-support');
          const data = await res.json();
          return data || {};
        } catch(e) {
          console.error('Failed to fetch user support:', e);
          return {};
        }
      }
      
      async function saveMajorSupport(symbol, value){
        try {
          await fetch('/api/major-support', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ symbol, major_support: value ? parseFloat(value) : null })
          });
        } catch(e) {
          console.error('Failed to save major support:', e);
        }
      }
      
      async function fetchMajorSupport(){
        try {
          const res = await fetch('/api/major-support');
          const data = await res.json();
          return data || {};
        } catch(e) {
          console.error('Failed to fetch major support:', e);
          return {};
        }
      }
      // Tabs logic
      // Tab elements
      const tabMain = document.getElementById('tab-main');
      const tabFiltered = document.getElementById('tab-filtered');
      const tabOrders = document.getElementById('tab-orders');
      const tabActive = document.getElementById('tab-active');
      const tabCK = document.getElementById('tab-ck');
      const tabFutures = document.getElementById('tab-futures');
      const tabVCP = document.getElementById('tab-vcp');
      const tabEmaHistory = document.getElementById('tab-ema-history');
      const tabTrades = document.getElementById('tab-trades');

      // Generic helper: show one view and highlight its tab with .active
      function setSelectedTab(tabEl, viewId){
        // hide all views
        ['view-main','view-filtered','view-orders','view-active','view-ck','view-futures','view-vcp','view-ema-history','view-trades'].forEach(id=>{
          const v = document.getElementById(id); if (v) v.style.display = 'none';
        });
        // normalize classes: set all tabs to exactly 'btn secondary' (remove active)
        [tabMain, tabFiltered, tabOrders, tabActive, tabCK, tabFutures, tabVCP, tabEmaHistory, tabTrades].forEach(t=>{
          if (!t) return;
          t.classList.remove('active');
          t.classList.remove('secondary');
          t.classList.add('secondary');
        });
        // show requested view and mark tab active (remove secondary)
        const view = document.getElementById(viewId);
        if (view) view.style.display = 'block';
        if (tabEl){
          tabEl.classList.remove('secondary');
          tabEl.classList.remove('active');
          tabEl.classList.add('active');
        }
      }

  tabMain.addEventListener('click', ()=> setSelectedTab(tabMain, 'view-main'));
      tabFiltered.addEventListener('click', ()=> setSelectedTab(tabFiltered, 'view-filtered'));
      tabOrders.addEventListener('click', ()=> { setSelectedTab(tabOrders, 'view-orders'); fetchOrders(); });
      if (tabActive) tabActive.addEventListener('click', ()=> { setSelectedTab(tabActive, 'view-active'); fetchActiveOrderbook(); });
  if (tabCK) tabCK.addEventListener('click', ()=> { setSelectedTab(tabCK, 'view-ck'); fetchCK(); });
  if (tabFutures) tabFutures.addEventListener('click', ()=> { setSelectedTab(tabFutures, 'view-futures'); fetchFutures(); });
  if (tabVCP) tabVCP.addEventListener('click', ()=> { setSelectedTab(tabVCP, 'view-vcp'); fetchVCP(); });
  if (tabEmaHistory) tabEmaHistory.addEventListener('click', ()=> { setSelectedTab(tabEmaHistory, 'view-ema-history'); fetchEmaHistory(); });
  if (tabTrades) tabTrades.addEventListener('click', ()=> { setSelectedTab(tabTrades, 'view-trades'); fetchTrades(); });

  // Default to All (main) tab on load
  setSelectedTab(tabMain, 'view-main');

  // CK Sub-tabs logic
  let ckActiveSubtab = 'momentum'; // 'momentum', 'reversals', 'averages', or 'strategy'
  const ckSubtabMomentum = document.getElementById('ck-subtab-momentum');
  const ckSubtabReversals = document.getElementById('ck-subtab-reversals');
  const ckSubtabAverages = document.getElementById('ck-subtab-averages');
  const ckSubtabStrategy = document.getElementById('ck-subtab-strategy');

  function setCKSubtab(subtab) {
    ckActiveSubtab = subtab;
    // Hide all CK views first
    document.getElementById('ck-view-momentum').style.display = 'none';
    document.getElementById('ck-view-reversals').style.display = 'none';
    document.getElementById('ck-view-averages').style.display = 'none';
    document.getElementById('ck-view-strategy').style.display = 'none';
    // Reset all sub-tab button styles
    ckSubtabMomentum.classList.remove('active'); ckSubtabMomentum.classList.add('secondary');
    ckSubtabReversals.classList.remove('active'); ckSubtabReversals.classList.add('secondary');
    ckSubtabAverages.classList.remove('active'); ckSubtabAverages.classList.add('secondary');
    if (ckSubtabStrategy) { ckSubtabStrategy.classList.remove('active'); ckSubtabStrategy.classList.add('secondary'); }
    // Show selected view and highlight its button
    if (subtab === 'momentum') {
      ckSubtabMomentum.classList.remove('secondary'); ckSubtabMomentum.classList.add('active');
      document.getElementById('ck-view-momentum').style.display = 'block';
    } else if (subtab === 'reversals') {
      ckSubtabReversals.classList.remove('secondary'); ckSubtabReversals.classList.add('active');
      document.getElementById('ck-view-reversals').style.display = 'block';
    } else if (subtab === 'averages') {
      ckSubtabAverages.classList.remove('secondary'); ckSubtabAverages.classList.add('active');
      document.getElementById('ck-view-averages').style.display = 'block';
    } else if (subtab === 'strategy') {
      ckSubtabStrategy.classList.remove('secondary'); ckSubtabStrategy.classList.add('active');
      document.getElementById('ck-view-strategy').style.display = 'block';
      fetchStrategyStatus(); // Fetch strategy status when switching to this tab
      fetchStrategyParameters(); // Fetch strategy parameters
    }
    renderCKTables();
  }

  if (ckSubtabMomentum) ckSubtabMomentum.addEventListener('click', () => setCKSubtab('momentum'));
  if (ckSubtabReversals) ckSubtabReversals.addEventListener('click', () => setCKSubtab('reversals'));
  if (ckSubtabAverages) ckSubtabAverages.addEventListener('click', () => setCKSubtab('averages'));
  if (ckSubtabStrategy) ckSubtabStrategy.addEventListener('click', () => setCKSubtab('strategy'));

  // Futures Sub-tabs logic
  let futuresActiveSubtab = 'momentum';
  const futuresSubtabMomentum = document.getElementById('futures-subtab-momentum');
  const futuresSubtabReversals = document.getElementById('futures-subtab-reversals');
  const futuresSubtabStrategy = document.getElementById('futures-subtab-strategy');

  function setFuturesSubtab(subtab) {
    futuresActiveSubtab = subtab;
    // Hide all Futures views first
    document.getElementById('futures-view-momentum').style.display = 'none';
    document.getElementById('futures-view-reversals').style.display = 'none';
    document.getElementById('futures-view-strategy').style.display = 'none';
    // Reset all sub-tab button styles
    futuresSubtabMomentum.classList.remove('active'); futuresSubtabMomentum.classList.add('secondary');
    futuresSubtabReversals.classList.remove('active'); futuresSubtabReversals.classList.add('secondary');
    if (futuresSubtabStrategy) { futuresSubtabStrategy.classList.remove('active'); futuresSubtabStrategy.classList.add('secondary'); }
    // Show selected view and highlight its button
    if (subtab === 'momentum') {
      futuresSubtabMomentum.classList.remove('secondary'); futuresSubtabMomentum.classList.add('active');
      document.getElementById('futures-view-momentum').style.display = 'block';
    } else if (subtab === 'reversals') {
      futuresSubtabReversals.classList.remove('secondary'); futuresSubtabReversals.classList.add('active');
      document.getElementById('futures-view-reversals').style.display = 'block';
    } else if (subtab === 'strategy') {
      futuresSubtabStrategy.classList.remove('secondary'); futuresSubtabStrategy.classList.add('active');
      document.getElementById('futures-view-strategy').style.display = 'block';
    }
    renderFuturesTables();
  }

  if (futuresSubtabMomentum) futuresSubtabMomentum.addEventListener('click', () => setFuturesSubtab('momentum'));
  if (futuresSubtabReversals) futuresSubtabReversals.addEventListener('click', () => setFuturesSubtab('reversals'));
  if (futuresSubtabStrategy) futuresSubtabStrategy.addEventListener('click', () => setFuturesSubtab('strategy'));

  let ckInterval = null;
  let latestCKRows = [];
  let sortStateCKMomentum = { key: 'rank_gm', dir: 'desc' };
  let sortStateCKReversals = { key: 'local_30d_low', dir: 'asc' };
  let sortStateCKAverages = { key: 'symbol', dir: 'asc' };

  function renderCKRowHtml(r) {
    const buyDisabled = (typeof r.last_price === 'number') ? '' : 'disabled';
    return `<td>${escapeHtml(r.symbol)}</td><td><span class="badge rank">${r.rank_gm != null ? r.rank_gm.toFixed(2) : ''}</span></td><td>${r.last_price!=null? r.last_price.toFixed(2): ''}</td><td>${r.rsi_15m!=null? r.rsi_15m.toFixed(2): ''}</td><td>${r.local_30d_low!=null? r.local_30d_low.toFixed(2)+'%': ''}</td><td>${r.local_30d_high!=null? r.local_30d_high.toFixed(2)+'%': ''}</td><td>${r.trading_zone_pct!=null? (r.trading_zone_pct*100).toFixed(2)+'%': ''}</td><td>${escapeHtml(r.signal||'')}</td><td>${escapeHtml(r.action||'')}</td><td><button class="btn small" onclick="placeBuy('${escapeHtml(r.symbol)}', this)" ${buyDisabled}>Buy</button></td>`;
  }

  function renderCKTables(){
    renderCKTablesAsync();
  }
  
  async function renderCKTablesAsync(){
    // Momentum table: Filter for momentum stocks (rank_gm > 0, bullish signals)
    const momentumRows = latestCKRows.filter(r => {
      // Momentum: positive rank, RSI > 40, bullish signal
      return (r.rank_gm != null && r.rank_gm > 0) || 
             (r.signal && (r.signal.includes('Bull') || r.signal === 'Neutral'));
    });
    applySort(momentumRows, sortStateCKMomentum);
    const tbodyMomentum = document.querySelector('#ck-table-momentum tbody');
    tbodyMomentum.innerHTML = '';
    for (const r of momentumRows){
      const tr = document.createElement('tr');
      tr.innerHTML = renderCKRowHtml(r);
      tbodyMomentum.appendChild(tr);
    }

    // Reversals at Levels table: Filter for stocks near support (local_30d_low < 5%)
    const reversalsRows = latestCKRows.filter(r => {
      // Near 30d low (within 5%) or oversold RSI
      return (r.local_30d_low != null && r.local_30d_low <= 5) ||
             (r.rsi_15m != null && r.rsi_15m < 35);
    });
    applySort(reversalsRows, sortStateCKReversals);
    const tbodyReversals = document.querySelector('#ck-table-reversals tbody');
    tbodyReversals.innerHTML = '';
    
    // Fetch user support and major support levels from DB
    const userSupportMap = await fetchUserSupport();
    const majorSupportMap = await fetchMajorSupport();
    
    for (const r of reversalsRows){
      const tr = document.createElement('tr');
      const userSup = userSupportMap[r.symbol] != null ? userSupportMap[r.symbol] : '';
      const majorSup = majorSupportMap[r.symbol] != null ? majorSupportMap[r.symbol] : '';
      const buyDisabled = (typeof r.last_price === 'number') ? '' : 'disabled';
      
      // Calculate color for last price based on % above user support
      let lastPriceColor = '';
      if (userSup && typeof r.last_price === 'number'){
        const pctAboveSupport = ((r.last_price - userSup) / userSup) * 100;
        if (pctAboveSupport <= 10){
          if (pctAboveSupport < 2){
            lastPriceColor = 'style="background-color: #90EE90; color: black;"'; // Green
          } else if (pctAboveSupport <= 5){
            lastPriceColor = 'style="background-color: #FFFF99; color: black;"'; // Yellow
          } else {
            lastPriceColor = 'style="background-color: #FF6B6B; color: white;"'; // Red
          }
        }
        // If > 10%, don't apply any color (lastPriceColor remains empty string)
      }
      
      tr.innerHTML = `<td>${r.symbol}</td><td><span class="badge rank">${r.rank_gm != null ? r.rank_gm.toFixed(2) : ''}</span></td><td><input type="number" step="1" placeholder="Support" value="${userSup}" onchange="saveUserSupport('${r.symbol}', this.value)" style="width:80px;" /></td><td ${lastPriceColor}>${r.last_price!=null? r.last_price.toFixed(2): ''}</td><td>${r.rsi_15m!=null? r.rsi_15m.toFixed(2): ''}</td><td><input type="number" step="1" placeholder="Major Sup" value="${majorSup}" onchange="saveMajorSupport('${r.symbol}', this.value)" style="width:80px;" /></td><td>${r.local_30d_low!=null? r.local_30d_low.toFixed(2)+'%': ''}</td><td>${r.local_30d_high!=null? r.local_30d_high.toFixed(2)+'%': ''}</td><td>${r.trading_zone_pct!=null? (r.trading_zone_pct*100).toFixed(2)+'%': ''}</td><td>${r.signal||''}</td><td>${r.action||''}</td><td><button class="btn small" onclick="placeBuy('${r.symbol}', this)" ${buyDisabled}>Buy</button></td>`;
      tbodyReversals.appendChild(tr);
    }

  // Averages table: show available EMAs (use latestCKRows order)
    const averagesBody = document.querySelector('#ck-table-averages tbody');
    if (averagesBody){
      averagesBody.innerHTML = '';
      // Sort using sortStateCKAverages (clickable headers)
      const avgRows = latestCKRows.slice();
      // Set ema_signal for sorting
      for (const r of avgRows){
        r.ema_signal = (typeof r.last_price==='number' && r.ema5!=null && r.ema8!=null && r.ema10!=null && (r.last_price>r.ema5 && r.ema5>r.ema8 && r.ema8>=r.ema10)) ? true : false;
      }
      applySort(avgRows, sortStateCKAverages);
      for (const r of avgRows){
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${r.symbol}</td>
          <td>${r.last_price!=null? r.last_price.toFixed(2): ''}</td>
          <td style="color:${r.ema_signal ? 'hsl(120,70%,38%)' : 'inherit'}">${r.ema_signal ? 'True' : 'False'}</td>
          <td>${r.ema5!=null? Number(r.ema5).toFixed(2): '<span class="muted">N/A</span>'}</td>
          <td>${r.ema8!=null? Number(r.ema8).toFixed(2): '<span class="muted">N/A</span>'}</td>
          <td>${r.ema10!=null? Number(r.ema10).toFixed(2): '<span class="muted">N/A</span>'}</td>
          <td>${r.ema20!=null? Number(r.ema20).toFixed(2): '<span class="muted">N/A</span>'}</td>
          <td>${r.ema50!=null? Number(r.ema50).toFixed(2): '<span class="muted">N/A</span>'}</td>
          <td>${r.ema100!=null? Number(r.ema100).toFixed(2): '<span class="muted">N/A</span>'}</td>
          <td>${r.ema200!=null? Number(r.ema200).toFixed(2): '<span class="muted">N/A</span>'}</td>
        `;
        averagesBody.appendChild(tr);
      }
    }
  }

  async function fetchCK(){
    try{
      const res = await fetch('/api/ck');
      const j = await res.json();
      if (!res.ok) throw new Error(j.error || 'Failed to fetch CK');
      const data = j.data || {};
      const syms = Object.keys(data).sort();
      // Build a map of rank_gm from latestRows (main LTP data)
      const rankMap = {};
      for (const row of latestRows) {
        if (row.symbol && row.rank_gm != null) {
          rankMap[row.symbol] = row.rank_gm;
        }
      }
      latestCKRows = syms.map(s=>{
        const info = data[s] || {};
        return {
          symbol: s,
          rank_gm: rankMap[s] != null ? rankMap[s] : null,
          last_price: (typeof info.last_price==='number')? info.last_price : (info.last_price? Number(info.last_price): null),
          rsi_15m: (typeof info.rsi_15m==='number')? info.rsi_15m : (info.rsi_15m? Number(info.rsi_15m): null),
          local_30d_low: info.local_30d_low != null ? info.local_30d_low : null,
          local_30d_high: info.local_30d_high != null ? info.local_30d_high : null,
          trading_zone_pct: info.trading_zone_pct != null ? info.trading_zone_pct : null,
          drawdown_15m_200_pct: info.drawdown_15m_200_pct != null ? info.drawdown_15m_200_pct : null,
          pullback_15m_200_pct: info.pullback_15m_200_pct != null ? info.pullback_15m_200_pct : null,
          signal: info.signal || '',
          action: info.action || ''
        };
      });
      // Attach EMA fields to latestCKRows if present in API
      for (const r of latestCKRows){
        const inf = data[r.symbol] || {};
        r.ema5 = (inf.ema5 != null) ? (typeof inf.ema5 === 'number' ? inf.ema5 : Number(inf.ema5)) : null;
        r.ema8 = (inf.ema8 != null) ? (typeof inf.ema8 === 'number' ? inf.ema8 : Number(inf.ema8)) : null;
        r.ema10 = (inf.ema10 != null) ? (typeof inf.ema10 === 'number' ? inf.ema10 : Number(inf.ema10)) : null;
        r.ema20 = (inf.ema20 != null) ? (typeof inf.ema20 === 'number' ? inf.ema20 : Number(inf.ema20)) : null;
        r.ema50 = (inf.ema50 != null) ? (typeof inf.ema50 === 'number' ? inf.ema50 : Number(inf.ema50)) : null;
        r.ema100 = (inf.ema100 != null) ? (typeof inf.ema100 === 'number' ? inf.ema100 : Number(inf.ema100)) : null;
        r.ema200 = (inf.ema200 != null) ? (typeof inf.ema200 === 'number' ? inf.ema200 : Number(inf.ema200)) : null;
      }
      renderCKTables();
    }catch(e){
      const tbodyM = document.querySelector('#ck-table-momentum tbody'); 
      const tbodyR = document.querySelector('#ck-table-reversals tbody'); 
      if (tbodyM) tbodyM.innerHTML = `<tr><td colspan="10" class="muted">${escapeHtml(e.message)}</td></tr>`;
      if (tbodyR) tbodyR.innerHTML = `<tr><td colspan="11" class="muted">${escapeHtml(e.message)}</td></tr>`;
    }
    // polling management: if CK view visible, ensure interval running
    try{ clearInterval(ckInterval); }catch(e){}
    if (document.getElementById('view-ck').style.display==='block') ckInterval = setInterval(fetchCK, 10000);
  }

  // Attach sorting to CK tables
  attachSortingFor('ck-table-momentum', sortStateCKMomentum, renderCKTables);
  attachSortingFor('ck-table-reversals', sortStateCKReversals, renderCKTables);
  // attach sorting for averages table
  attachSortingFor('ck-table-averages', sortStateCKAverages, renderCKTables);

  // Futures Tab Logic
  let futuresInterval = null;
  let latestFuturesRows = [];
  let sortStateFuturesMomentum = { key: 'last_price', dir: 'desc' };
  let sortStateFuturesReversals = { key: 'last_price', dir: 'asc' };

  function renderFuturesRowHtml(r) {
    const buyDisabled = (typeof r.last_price === 'number') ? '' : 'disabled';
    return `<td>${escapeHtml(r.symbol)}</td><td>${r.expiry || ''}</td><td>${r.last_price!=null? r.last_price.toFixed(2): ''}</td><td>${r.rsi_15m!=null? r.rsi_15m.toFixed(2): ''}</td><td>${r.sma50_15m!=null? r.sma50_15m.toFixed(2): ''}</td><td>${r.sma200_15m!=null? r.sma200_15m.toFixed(2): ''}</td><td>${r.pct_vs_15m_sma50!=null? r.pct_vs_15m_sma50.toFixed(2)+'%': ''}</td><td>${escapeHtml(r.signal||'')}</td><td>${escapeHtml(r.action||'')}</td><td><button class="btn small" onclick="placeBuy('${escapeHtml(r.symbol)}', this)" ${buyDisabled}>Buy</button></td>`;
  }

  function renderFuturesTables(){
    // Momentum table
    const momentumRows = latestFuturesRows.filter(r => {
      return (r.signal && (r.signal.includes('Bull') || r.signal === 'Neutral'));
    });
    applySort(momentumRows, sortStateFuturesMomentum);
    const tbodyMomentum = document.querySelector('#futures-table-momentum tbody');
    if (tbodyMomentum) {
      tbodyMomentum.innerHTML = '';
      for (const r of momentumRows){
        const tr = document.createElement('tr');
        tr.innerHTML = renderFuturesRowHtml(r);
        tbodyMomentum.appendChild(tr);
      }
    }

    // Reversals table
    const reversalsRows = latestFuturesRows.filter(r => {
      return (r.rsi_15m != null && (r.rsi_15m < 30 || r.rsi_15m > 70));
    });
    applySort(reversalsRows, sortStateFuturesReversals);
    const tbodyReversals = document.querySelector('#futures-table-reversals tbody');
    if (tbodyReversals) {
      tbodyReversals.innerHTML = '';
      for (const r of reversalsRows){
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${escapeHtml(r.symbol)}</td><td>${r.expiry || ''}</td><td>${r.last_price!=null? r.last_price.toFixed(2): ''}</td><td>${r.rsi_15m!=null? r.rsi_15m.toFixed(2): ''}</td><td>${r.sma50_15m!=null? r.sma50_15m.toFixed(2): ''}</td><td>${r.sma200_15m!=null? r.sma200_15m.toFixed(2): ''}</td><td>${escapeHtml(r.signal||'')}</td><td>${escapeHtml(r.action||'')}</td><td><button class="btn small" onclick="placeBuy('${escapeHtml(r.symbol)}', this)">Buy</button></td>`;
        tbodyReversals.appendChild(tr);
      }
    }
  }

  async function fetchFutures(){
    try{
      const res = await fetch('/api/futures');
      const j = await res.json();
      if (!res.ok) throw new Error(j.error || 'Failed to fetch Futures');
      const data = j.data || {};
      const syms = Object.keys(data).sort();
      
      latestFuturesRows = syms.map(s=>{
        const info = data[s] || {};
        return {
          symbol: escapeHtml(info.symbol || s),
          expiry: info.expiry || '',
          last_price: (typeof info.last_price==='number')? info.last_price : (info.last_price? Number(info.last_price): null),
          rsi_15m: (typeof info.rsi_15m==='number')? info.rsi_15m : (info.rsi_15m? Number(info.rsi_15m): null),
          sma50_15m: (typeof info.sma50_15m==='number')? info.sma50_15m : (info.sma50_15m? Number(info.sma50_15m): null),
          sma200_15m: (typeof info.sma200_15m==='number')? info.sma200_15m : (info.sma200_15m? Number(info.sma200_15m): null),
          pct_vs_15m_sma50: (typeof info.pct_vs_15m_sma50==='number')? info.pct_vs_15m_sma50 : (info.pct_vs_15m_sma50? Number(info.pct_vs_15m_sma50): null),
          signal: info.signal || '',
          action: info.action || ''
        };
      });
      renderFuturesTables();
    }catch(e){
      const tbodyM = document.querySelector('#futures-table-momentum tbody'); 
      const tbodyR = document.querySelector('#futures-table-reversals tbody'); 
      if (tbodyM) tbodyM.innerHTML = `<tr><td colspan="10" class="muted">${escapeHtml(e.message)}</td></tr>`;
      if (tbodyR) tbodyR.innerHTML = `<tr><td colspan="9" class="muted">${escapeHtml(e.message)}</td></tr>`;
    }
    // polling management
    try{ clearInterval(futuresInterval); }catch(e){}
    if (document.getElementById('view-futures') && document.getElementById('view-futures').style.display==='block') futuresInterval = setInterval(fetchFutures, 10000);
  }

  // Attach sorting to Futures tables
  attachSortingFor('futures-table-momentum', sortStateFuturesMomentum, renderFuturesTables);
  attachSortingFor('futures-table-reversals', sortStateFuturesReversals, renderFuturesTables);

  // VCP Tab Logic
  let vcpInterval = null;
  let latestVCPRows = [];
  let sortStateVCP = { key: 'distance', dir: 'asc' };

  function renderVCPRowHtml(r) {
    // Pattern stage coloring based on phase
    let patternBg = '#f0f0f0';
    if (r.pattern_stage && r.pattern_stage.includes('Phase 4')) patternBg = '#d4edda'; // green - breakout
    else if (r.pattern_stage && r.pattern_stage.includes('Phase 3')) patternBg = '#fff3cd'; // yellow - ready
    else if (r.pattern_stage && (r.pattern_stage.includes('Phase 1') || r.pattern_stage.includes('Phase 2') || r.pattern_stage.includes('Consolidating'))) patternBg = '#d1ecf1'; // blue - building
    else if (r.pattern_stage && r.pattern_stage.includes('EMA50')) patternBg = '#f8d7da'; // red - no trend
    
    // Entry signal coloring: 'BUY' (green), 'WATCH' (yellow), 'WAIT' (orange), 'NONE' (gray)
    let signalBg = '#f0f0f0';
    let signalColor = '#666';
    if (r.entry_signal === 'BUY') { signalBg = '#28a745'; signalColor = '#fff'; }
    else if (r.entry_signal === 'WATCH') { signalBg = '#ffc107'; signalColor = '#212529'; }
    else if (r.entry_signal === 'WAIT') { signalBg = '#dc6317'; signalColor = '#fff'; }
    
    // Confidence score coloring
    let confBg = '#f0f0f0';
    let confScore = r.confidence_score != null ? r.confidence_score : 0;
    if (confScore >= 0.7) confBg = '#d4edda'; // high confidence
    else if (confScore >= 0.5) confBg = '#fff3cd'; // medium
    else if (confScore > 0) confBg = '#f8d7da'; // low
    
    // Distance coloring: negative (red, below breakout), positive (green, above)
    let distanceBg = 'transparent';
    if (r.distance != null) {
      distanceBg = r.distance < 0 ? '#ffe6e6' : '#e6ffe6';
    }
    
    // Volatility trend icon
    let volTrendIcon = r.volatility_trend === 'Decreasing' ? '↓' : (r.volatility_trend === 'Increasing' ? '↑' : '');
    let volTrendBg = r.volatility_trend === 'Decreasing' ? '#d4edda' : (r.volatility_trend === 'Increasing' ? '#f8d7da' : 'transparent');
    
    // Trade button - enabled only for BUY or WATCH signals
    const tradeDisabled = (typeof r.last_price === 'number' && (r.entry_signal === 'BUY' || r.entry_signal === 'WATCH')) ? '' : 'disabled';
    const tradeBtnStyle = tradeDisabled ? 'background:#ccc;' : 'background:#28a745;color:#fff;';
    
    return `<td style="font-weight:bold;">${escapeHtml(r.symbol)}</td>
            <td style="background-color: ${patternBg}; padding: 6px; font-size: 11px;">${escapeHtml(r.pattern_stage || 'No Pattern')}</td>
            <td style="background-color: ${signalBg}; color: ${signalColor}; padding: 6px; font-weight: bold; text-align:center;">${escapeHtml(r.entry_signal || 'NONE')}</td>
            <td style="background-color: ${confBg}; text-align:center;">${confScore > 0 ? (confScore * 100).toFixed(0) + '%' : '-'}</td>
            <td>${r.last_price != null ? r.last_price.toFixed(2) : ''}</td>
            <td style="color:#155724; font-weight:bold;">${r.entry_price != null ? r.entry_price.toFixed(2) : '-'}</td>
            <td style="color:#dc3545; font-weight:bold;">${r.stop_loss != null ? r.stop_loss.toFixed(2) : '-'}</td>
            <td style="color:#28a745; font-weight:bold;">${r.target != null ? r.target.toFixed(2) : '-'}</td>
            <td style="background-color: ${distanceBg}; text-align:center;">${r.distance != null ? r.distance.toFixed(2) + '%' : ''}</td>
            <td>${r.breakout_level != null ? r.breakout_level.toFixed(2) : ''}</td>
            <td style="text-align:center;">${r.num_contractions || '-'}</td>
            <td style="background-color: ${volTrendBg}; text-align:center;">${volTrendIcon} ${escapeHtml(r.volatility_trend || '-')}</td>
            <td>${escapeHtml(r.signal || '')}</td>
            <td><button class="btn small" style="${tradeBtnStyle}" onclick="placeBuy('${escapeHtml(r.symbol)}', this)" ${tradeDisabled}>Trade</button></td>`;
  }

  function renderVCPTable() {
    applySort(latestVCPRows, sortStateVCP);
    const tbody = document.querySelector('#vcp-table tbody');
    if (!tbody) return;
    tbody.innerHTML = '';
    if (latestVCPRows.length === 0) {
      tbody.innerHTML = '<tr><td colspan="14" class="muted">No VCP patterns detected</td></tr>';
      return;
    }
    for (const r of latestVCPRows) {
      const tr = document.createElement('tr');
      tr.innerHTML = renderVCPRowHtml(r);
      tbody.appendChild(tr);
    }
  }

  async function fetchVCP() {
    try {
      const res = await fetch('/api/vcp');
      const j = await res.json();
      if (!res.ok) throw new Error(j.error || 'Failed to fetch VCP');
      
      const data = j.data || {};
      const symbols = Object.keys(data).sort();
      latestVCPRows = symbols.map(symbol => {
        const item = data[symbol] || {};
        return {
          symbol: symbol,
          pattern_stage: item.pattern_stage || 'No Pattern Detected',
          entry_signal: item.entry_signal || 'NONE',
          confidence_score: (typeof item.confidence_score === 'number') ? item.confidence_score : null,
          last_price: (typeof item.last_price === 'number') ? item.last_price : (item.last_price ? Number(item.last_price) : null),
          entry_price: (typeof item.entry_price === 'number') ? item.entry_price : (item.entry_price ? Number(item.entry_price) : null),
          stop_loss: (typeof item.stop_loss === 'number') ? item.stop_loss : (item.stop_loss ? Number(item.stop_loss) : null),
          target: (typeof item.target === 'number') ? item.target : (item.target ? Number(item.target) : null),
          breakout_level: (typeof item.breakout_level === 'number') ? item.breakout_level : (item.breakout_level ? Number(item.breakout_level) : null),
          distance: (typeof item.distance_to_breakout === 'number') ? item.distance_to_breakout : (item.distance_to_breakout ? Number(item.distance_to_breakout) : null),
          num_contractions: item.num_contractions || 0,
          volatility_trend: item.volatility_trend || '',
          signal: item.ck_signal || ''
        };
      });
      
      renderVCPTable();
    } catch (e) {
      const tbody = document.querySelector('#vcp-table tbody');
      if (tbody) tbody.innerHTML = `<tr><td colspan="11" class="muted">${escapeHtml(e.message)}</td></tr>`;
    }
    
    // polling management: if VCP view visible, ensure interval running
    try { clearInterval(vcpInterval); } catch (e) {}
    if (document.getElementById('view-vcp') && document.getElementById('view-vcp').style.display === 'block') {
      vcpInterval = setInterval(fetchVCP, 10000);
    }
  }

  // Attach sorting to VCP table
  attachSortingFor('vcp-table', sortStateVCP, renderVCPTable);

  // ========== EMA HISTORY (15-MINUTE) LOGIC ==========
  let latestEmaHistoryRows = [];
  let sortStateEmaHistory = { key: 'timestamp', dir: 'desc' };
  let emaHistoryInterval = null;
  let emaHistoryFilterSymbol = '';

  function renderEmaHistoryTable() {
    applySort(latestEmaHistoryRows, sortStateEmaHistory);
    const tbody = document.querySelector('#ema-history-table tbody');
    if (!tbody) return;
    tbody.innerHTML = '';
    
    // Apply symbol filter if set
    const filterSymbol = document.getElementById('ema-filter-symbol')?.value?.trim().toUpperCase() || '';
    let filtered = latestEmaHistoryRows;
    if (filterSymbol) {
      filtered = latestEmaHistoryRows.filter(r => r.symbol && r.symbol.toUpperCase().includes(filterSymbol));
    }
    
    if (filtered.length === 0) {
      tbody.innerHTML = '<tr><td colspan="7" class="muted">No EMA history data available</td></tr>';
      return;
    }
    
    for (const r of filtered) {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${r.timestamp || ''}</td>
        <td><strong>${r.symbol || ''}</strong></td>
        <td>${r.ema_20 != null ? Number(r.ema_20).toFixed(2) : '<span class="muted">-</span>'}</td>
        <td>${r.ema_50 != null ? Number(r.ema_50).toFixed(2) : '<span class="muted">-</span>'}</td>
        <td>${r.ema_100 != null ? Number(r.ema_100).toFixed(2) : '<span class="muted">-</span>'}</td>
        <td>${r.ema_200 != null ? Number(r.ema_200).toFixed(2) : '<span class="muted">-</span>'}</td>
        <td class="num"><strong>${r.ltp != null ? Number(r.ltp).toFixed(2) : '<span class="muted">-</span>'}</strong></td>
      `;
      tbody.appendChild(tr);
    }
  }

  async function fetchEmaHistory() {
    try {
      const res = await fetch('/api/ema-history');
      const j = await res.json();
      if (!res.ok) throw new Error(j.error || 'Failed to fetch EMA history');
      
      const data = j.data || {};
      const rows = [];
      
      // Transform data into rows format
      // Expected format: { symbol: { candles: [...] } } or flat list
      if (Array.isArray(data)) {
        // If it's an array of candle records
        for (const candle of data) {
          rows.push({
            timestamp: candle.timestamp || '',
            symbol: candle.symbol || '',
            ema_20: (typeof candle.ema_20 === 'number') ? candle.ema_20 : (candle.ema_20 ? Number(candle.ema_20) : null),
            ema_50: (typeof candle.ema_50 === 'number') ? candle.ema_50 : (candle.ema_50 ? Number(candle.ema_50) : null),
            ema_100: (typeof candle.ema_100 === 'number') ? candle.ema_100 : (candle.ema_100 ? Number(candle.ema_100) : null),
            ema_200: (typeof candle.ema_200 === 'number') ? candle.ema_200 : (candle.ema_200 ? Number(candle.ema_200) : null),
            ltp: (typeof candle.ltp === 'number') ? candle.ltp : (candle.ltp ? Number(candle.ltp) : null)
          });
        }
      } else {
        // If it's an object with symbols as keys
        for (const symbol of Object.keys(data).sort()) {
          const symbolData = data[symbol];
          if (symbolData && Array.isArray(symbolData.candles)) {
            for (const candle of symbolData.candles) {
              rows.push({
                timestamp: candle.timestamp || '',
                symbol: symbol,
                ema_20: (typeof candle.ema_20 === 'number') ? candle.ema_20 : (candle.ema_20 ? Number(candle.ema_20) : null),
                ema_50: (typeof candle.ema_50 === 'number') ? candle.ema_50 : (candle.ema_50 ? Number(candle.ema_50) : null),
                ema_100: (typeof candle.ema_100 === 'number') ? candle.ema_100 : (candle.ema_100 ? Number(candle.ema_100) : null),
                ema_200: (typeof candle.ema_200 === 'number') ? candle.ema_200 : (candle.ema_200 ? Number(candle.ema_200) : null),
                ltp: (typeof candle.ltp === 'number') ? candle.ltp : (candle.ltp ? Number(candle.ltp) : null)
              });
            }
          }
        }
      }
      
      latestEmaHistoryRows = rows;
      renderEmaHistoryTable();
    } catch (e) {
      const tbody = document.querySelector('#ema-history-table tbody');
      if (tbody) tbody.innerHTML = `<tr><td colspan="7" class="muted">${escapeHtml(e.message)}</td></tr>`;
    }
    
    // Polling management: if EMA History view visible, ensure interval running
    try { clearInterval(emaHistoryInterval); } catch (err) {}
    if (document.getElementById('view-ema-history').style.display === 'block') {
      emaHistoryInterval = setInterval(fetchEmaHistory, 10000);
    }
  }

  // Attach sorting to EMA History table
  attachSortingFor('ema-history-table', sortStateEmaHistory, renderEmaHistoryTable);

  // Filter event listener
  const emaFilterInput = document.getElementById('ema-filter-symbol');
  if (emaFilterInput) {
    emaFilterInput.addEventListener('keyup', renderEmaHistoryTable);
  }

  // Refresh button
  const btnRefreshEmaHistory = document.getElementById('btn-refresh-ema-history');
  if (btnRefreshEmaHistory) {
    btnRefreshEmaHistory.addEventListener('click', fetchEmaHistory);
  }

  // Active Orderbook sorting
  let sortStateActiveOrders = { key: 'symbol', dir: 'asc' };
  let sortStateActiveGTT = { key: 'symbol', dir: 'asc' };

  // Render functions need to apply sorting before rendering
  function renderActiveOrdersWithSort(orders, ltpData) {
    if (!orders || orders.length === 0) {
      const tbody = document.querySelector('#active-orders-table tbody');
      if (tbody) tbody.innerHTML = '<tr><td colspan="8" class="muted">No active orders</td></tr>';
      return;
    }
    // Convert orders to sortable format
    const rows = orders.map(o => ({
      ...o,
      symbol: o.tradingsymbol || o.symbol || o.instrument_token || '',
      order_id: o.order_id || o.orderId || '',
      qty: o.quantity || o.qty || o.pending_qty || '',
      price: o.price || o.avg_price || '',
      ltp: (ltpData && ltpData[o.tradingsymbol || o.symbol] && ltpData[o.tradingsymbol || o.symbol].last_price) ? ltpData[o.tradingsymbol || o.symbol].last_price : null,
      status: o.status || '',
      type: o.order_type || o.type || ''
    }));
    // Apply sort
    applySort(rows, sortStateActiveOrders);
    const tbody = document.querySelector('#active-orders-table tbody');
    tbody.innerHTML = '';
    for (const o of rows) {
      const tr = document.createElement('tr');
      const ltpStr = o.ltp ? parseFloat(o.ltp).toFixed(2) : '';
      tr.innerHTML = `
        <td>${o.symbol}</td>
        <td>${o.order_id}</td>
        <td>${o.qty}</td>
        <td>${o.price}</td>
        <td class="num">${ltpStr}</td>
        <td>${o.status}</td>
        <td>${o.type}</td>
        <td>
          ${o.order_id? `<button class="btn small" onclick="cancelOrder('${o.order_id}', '${o.symbol}', this)">Cancel</button>` : ''}
        </td>
      `;
      tbody.appendChild(tr);
    }
  }

  function renderActiveGTTsWithSort(gtts, ltpData) {
    ltpData = ltpData || {};
    const tbody = document.querySelector('#active-gtt-table tbody');
    if (!gtts || Object.keys(gtts).length === 0) {
      tbody.innerHTML = '<tr><td colspan="9" class="muted">No GTT orders</td></tr>';
      return;
    }
    const list = Array.isArray(gtts) ? gtts : (gtts.items || gtts.gtts || Object.values(gtts));
    if (!list || list.length === 0) {
      tbody.innerHTML = '<tr><td colspan="9" class="muted">No GTT orders</td></tr>';
      return;
    }
    
    // Convert GTTs to sortable format
    const rows = [];
    for (const g of list) {
      const condition = g.condition || {};
      const symbol = condition.tradingsymbol || g.tradingsymbol || g.symbol || '';
      const gtt_id = g.id || g.gtt_id || g.trigger_id || '';
      const triggerValues = condition.trigger_values || g.trigger_values || [];
      const type = g.type || g.trigger_type || '';
      const status = g.status || g.state || '';
      
      const orders = g.orders || [];
      let qty = '';
      if (Array.isArray(orders) && orders.length > 0) {
        qty = orders[0].quantity || orders[0].qty || '';
      }
      
      const ltpInfo = ltpData[symbol] || {};
      const ltp = typeof ltpInfo.last_price === 'number' ? ltpInfo.last_price : null;
      
      let stopPrice = null;
      let targetPrice = null;
      if (Array.isArray(triggerValues) && triggerValues.length > 0) {
        const vals = triggerValues.map(v => parseFloat(v)).filter(v => !isNaN(v)).sort((a,b) => a - b);
        if (vals.length >= 2) {
          stopPrice = vals[0];
          targetPrice = vals[vals.length - 1];
        } else if (vals.length === 1) {
          stopPrice = vals[0];
        }
      }
      
      rows.push({
        original: g,
        symbol,
        gtt_id,
        qty: parseInt(qty) || 0,
        ltp: ltp || 0,
        stop: stopPrice || 0,
        target: targetPrice || 0,
        type,
        status,
        triggerValues,
        stopPrice,
        targetPrice,
        ltpInfo
      });
    }
    
    // Apply sort
    applySort(rows, sortStateActiveGTT);
    tbody.innerHTML = '';
    
    for (const r of rows) {
      const ltp = r.ltp;
      const stopPrice = r.stopPrice;
      const targetPrice = r.targetPrice;
      
      let stopStr = stopPrice !== null ? stopPrice.toFixed(2) : '';
      let targetStr = targetPrice !== null ? targetPrice.toFixed(2) : '';
      let stopStyle = '';
      let targetStyle = '';
      
      if (ltp !== null && ltp !== 0 && stopPrice !== null) {
        const stopPct = ((ltp - stopPrice) / ltp * 100).toFixed(1);
        stopStr = `${stopPrice.toFixed(2)} (${stopPct}%)`;
        if (parseFloat(stopPct) < 2) stopStyle = 'color: var(--danger); font-weight: 600;';
        else if (parseFloat(stopPct) < 5) stopStyle = 'color: #b8860b; font-weight: 600;';
        else stopStyle = 'color: var(--success);';
      }
      
      if (ltp !== null && ltp !== 0 && targetPrice !== null) {
        const targetPct = ((targetPrice - ltp) / ltp * 100).toFixed(1);
        targetStr = `${targetPrice.toFixed(2)} (${targetPct}%)`;
        if (parseFloat(targetPct) < 2) targetStyle = 'color: var(--success); font-weight: 600;';
        else if (parseFloat(targetPct) < 5) targetStyle = 'color: #b8860b; font-weight: 600;';
      }
      
      const tr = document.createElement('tr');
      const gttType = (r.type === 'two-leg' || r.triggerValues.length >= 2) ? 'oco' : 'single';
      const ltpStr = ltp && ltp !== 0 ? ltp.toFixed(2) : '';
      
      tr.innerHTML = `
        <td>${r.symbol}</td>
        <td>${r.gtt_id}</td>
        <td class="num">${r.qty}</td>
        <td class="num">${ltpStr}</td>
        <td class="num" style="${stopStyle}">${stopStr}</td>
        <td class="num" style="${targetStyle}">${targetStr}</td>
        <td>${r.type}</td>
        <td>${r.status}</td>
        <td>
          ${r.gtt_id && r.symbol && r.qty && stopPrice ? `<button class="btn small" onclick="startTrailing('${r.symbol}','${r.gtt_id}','${r.qty}','${stopPrice}','${gttType}','${targetPrice || 0}', this)" title="Enable trailing stop">Trail</button>` : ''}
          ${r.gtt_id && r.symbol && ltp ? `<button class="btn small secondary" onclick="bookGTT('${r.gtt_id}','${r.symbol}','${r.qty}','${stopPrice}','${ltp}', this)" style="background:#3b82f6;border-color:#3b82f6;color:white;" title="Set target to LTP, keep stop same">Book</button>` : ''}
        </td>
      `;
      tbody.appendChild(tr);
    }
  }

  // Attach sorting
  attachSortingFor('active-orders-table', sortStateActiveOrders, () => {
    // Fetch and re-render with new sort
    fetchActiveOrderbook();
  });
  attachSortingFor('active-gtt-table', sortStateActiveGTT, () => {
    fetchActiveOrderbook();
  });

  // ========== STRATEGY OPEN POSITIONS SORTING ==========
  let sortStateStrategyOpen = { key: 'entry_time', dir: 'desc' };
  
  function renderStrategyOpenTable(trades) {
    const openTbody = document.getElementById('strategy-open-tbody');
    if (!trades || trades.length === 0) {
      openTbody.innerHTML = '<tr><td colspan="11" style="text-align:center; color:#94a3b8; padding:20px;">No open positions</td></tr>';
      return;
    }
    
    // Apply sorting
    const sortedTrades = trades.slice();
    applySort(sortedTrades, sortStateStrategyOpen);
    
    // Render sorted trades
    openTbody.innerHTML = sortedTrades.map(t => {
      const pnlColor = (t.current_pnl_pct || 0) >= 0 ? '#16a34a' : '#dc2626';
      const ltp = (t.ltp && !isNaN(t.ltp)) ? Number(t.ltp) : null;

      // Determine stop/target styles: only color when within ±1% of LTP
      let stopStyle = '';
      let targetStyle = '';
      const thresholdPct = 1.0; // 1 percent

      if (ltp && t.stop_loss) {
        const stop = Number(t.stop_loss);
        const stopDiffPct = Math.abs((ltp - stop) / ltp) * 100;
        if (!isNaN(stopDiffPct) && stopDiffPct <= thresholdPct) {
          stopStyle = 'color:#dc2626;';
        }
      }

      if (ltp && t.target) {
        const target = Number(t.target);
        const targetDiffPct = Math.abs((ltp - target) / ltp) * 100;
        if (!isNaN(targetDiffPct) && targetDiffPct <= thresholdPct) {
          targetStyle = 'color:#16a34a;';
        }
      }

      return `<tr data-trade-id="${t.trade_id}">
        <td><span class="badge" style="background:#3b82f6;color:white;">P${t.position_number}</span></td>
        <td><strong>${t.symbol}</strong></td>
        <td>${formatDateTimeShort(t.entry_time)}</td>
        <td>₹${t.entry_price?.toFixed(2) || '-'}</td>
        <td>${t.qty}</td>
        <td>₹${t.ltp?.toFixed(2) || '-'}</td>
        <td style="${stopStyle}">₹${t.stop_loss?.toFixed(2) || '-'}</td>
        <td style="${targetStyle}">${t.target ? '₹' + t.target.toFixed(2) : 'Runner'}</td>
        <td style="color:${pnlColor};font-weight:600;">${t.current_pnl_pct?.toFixed(2) || '0.00'}%</td>
        <td style="color:${pnlColor};font-weight:600;">₹${t.current_pnl_inr?.toFixed(2) || '0.00'}</td>
        <td>
          <button class="btn small" style="background:#3b82f6;border-color:#3b82f6;" onclick="bookPosition(${t.trade_id}, '${t.symbol}', ${t.ltp || 0})">Book</button>
          <button class="btn small" style="background:#16a34a;border-color:#16a34a;margin-left:4px;" onclick="clearPosition(${t.trade_id}, '${t.symbol}', ${t.ltp || 0})">Clear</button>
        </td>
      </tr>`;
    }).join('');
  }
  
  attachSortingFor('strategy-open-table', sortStateStrategyOpen, () => {
    // Re-render with new sort - fetch latest status to get trades
    fetchStrategyStatus();
  });

  // ========== MOMENTUM STRATEGY FUNCTIONS ==========
  let strategyInterval = null;
  let strategyTimerInterval = null;  // For continuous countdown
  let strategyNextScanSeconds = 60;  // Track countdown locally

  async function fetchStrategyStatus() {
    try {
      const res = await fetch('/api/strategy/momentum/status');
      const data = await res.json();
      if (!res.ok) throw new Error(data.error || 'Failed to fetch strategy status');
      updateStrategyUI(data);
    } catch (e) {
      console.error('fetchStrategyStatus error:', e);
      // Show error state
      document.getElementById('strategy-status-badge').textContent = 'ERROR';
      document.getElementById('strategy-status-badge').style.background = '#f97316';
    }
  }

  async function fetchStrategyParameters() {
    try {
      const res = await fetch('/api/strategy/momentum/parameters');
      const params = await res.json();
      if (!res.ok) throw new Error(params.error || 'Failed to fetch parameters');
      
      // Update Position 1
      document.getElementById('p1-entry').textContent = 'Entry: ' + params.position_1.entry;
      document.getElementById('p1-sl').textContent = `SL: ${params.position_1.stop_loss_pct} (${params.position_1.stop_loss_type})`;
      document.getElementById('p1-target').textContent = 'Target: ' + params.position_1.target_pct;
      
      // Update Position 2
      document.getElementById('p2-entry').textContent = 'Entry: ' + params.position_2.entry;
      document.getElementById('p2-sl').textContent = `SL: ${params.position_2.stop_loss_pct} (${params.position_2.stop_loss_type})`;
      document.getElementById('p2-target').textContent = 'Target: ' + params.position_2.target_pct;
      
      // Update Position 3
      document.getElementById('p3-entry').textContent = 'Entry: ' + params.position_3.entry;
      document.getElementById('p3-sl').textContent = `SL: ${params.position_3.stop_loss_pct} (${params.position_3.stop_loss_type})`;
      document.getElementById('p3-target').textContent = 'Target: ' + params.position_3.target_pct;
      
    } catch (e) {
      console.error('fetchStrategyParameters error:', e);
    }
  }

  function updateTimerDisplay() {
    const nextScanEl = document.getElementById('strategy-next-scan');
    if (!nextScanEl) return;
    
    nextScanEl.textContent = strategyNextScanSeconds + 's';
    
    // Color based on time remaining
    if (strategyNextScanSeconds <= 10) {
      nextScanEl.style.color = '#dc2626'; // Red when close
    } else if (strategyNextScanSeconds <= 30) {
      nextScanEl.style.color = '#ea580c'; // Orange
    } else {
      nextScanEl.style.color = '#b45309'; // Amber
    }
    
    // Decrement for next tick
    if (strategyNextScanSeconds > 0) {
      strategyNextScanSeconds--;
    }
  }

  // Format ISO datetime to '16 Jan 12:29:54 PM' (no year)
  function formatDateTimeShort(isoStr) {
    try {
      if (!isoStr) return '-';
      const d = new Date(isoStr);
      if (isNaN(d.getTime())) return '-';
      const day = d.getDate();
      const month = d.toLocaleString(undefined, { month: 'short' });
      // Force 12-hour time with seconds: '12:29:54 PM'
      const time = d.toLocaleTimeString(undefined, { hour12: true, hour: '2-digit', minute: '2-digit', second: '2-digit' });
      return `${day} ${month} ${time}`;
    } catch (e) {
      return '-';
    }
  }

  function startTimerCountdown() {
    // Clear any existing timer
    if (strategyTimerInterval) {
      clearInterval(strategyTimerInterval);
    }
    // Update every second
    strategyTimerInterval = setInterval(updateTimerDisplay, 1000);
  }

  function stopTimerCountdown() {
    if (strategyTimerInterval) {
      clearInterval(strategyTimerInterval);
      strategyTimerInterval = null;
    }
  }

  function updateStrategyUI(data) {
    // Update status badge
    const badge = document.getElementById('strategy-status-badge');
    const btnStart = document.getElementById('btn-strategy-start');
    const btnStop = document.getElementById('btn-strategy-stop');
    const timerContainer = document.getElementById('strategy-timer-container');
    const nextScanEl = document.getElementById('strategy-next-scan');
    
    // Update mode from server response
    const mode = data.mode || 'PAPER';
    selectedMode = mode;  // Sync with selected mode variable
    
    // Update mode buttons styling
    const btnPaper = document.getElementById('btn-mode-paper');
    const btnLive = document.getElementById('btn-mode-live');
    
    if (mode === 'LIVE') {
      btnLive.style.background = '#dc2626';
      btnLive.style.borderColor = '#dc2626';
      btnLive.style.color = 'white';
      btnPaper.style.background = 'white';
      btnPaper.style.borderColor = '#fca5a5';
      btnPaper.style.color = '#ef4444';
    } else {
      btnPaper.style.background = '#ef4444';
      btnPaper.style.borderColor = '#ef4444';
      btnPaper.style.color = 'white';
      btnLive.style.background = 'white';
      btnLive.style.borderColor = '#fca5a5';
      btnLive.style.color = '#dc2626';
    }
    
    if (data.running) {
      badge.textContent = 'RUNNING';
      badge.style.background = '#22c55e';
      btnStart.style.display = 'none';
      btnStop.style.display = 'inline-block';
      // Show timer when running
      timerContainer.style.display = 'inline-block';
      // Sync countdown from server
      strategyNextScanSeconds = data.next_scan_in || 60;
      updateTimerDisplay();
      // Start continuous countdown if not running
      if (!strategyTimerInterval) {
        startTimerCountdown();
      }
    } else {
      badge.textContent = 'STOPPED';
      badge.style.background = '#ef4444';
      btnStart.style.display = 'inline-block';
      btnStop.style.display = 'none';
      // Hide timer when stopped
      stopTimerCountdown();
      timerContainer.style.display = 'none';
    }
    
    // Update capital info (new fields)
    document.getElementById('strategy-per-position').textContent = (data.capital_per_position || 5000).toLocaleString();
    document.getElementById('strategy-positions').textContent = data.active_positions || '0';
    document.getElementById('strategy-max-positions').textContent = data.max_positions || '20';
    
    // Update capital summary panel
    document.getElementById('strategy-total-capital').textContent = (data.total_capital || 100000).toLocaleString();
    document.getElementById('strategy-deployed-capital').textContent = (data.deployed_capital || 0).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
    document.getElementById('strategy-current-value').textContent = (data.current_value || 0).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
    
    // Update unrealized PnL with color
    const unrealizedPnl = data.unrealized_pnl || 0;
    const unrealizedEl = document.getElementById('strategy-unrealized-pnl');
    const unrealizedContainer = document.getElementById('strategy-unrealized-pnl-container');
    const sign = unrealizedPnl >= 0 ? '+' : '';
    unrealizedEl.textContent = sign + '₹' + unrealizedPnl.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
    unrealizedContainer.style.color = unrealizedPnl >= 0 ? '#16a34a' : '#dc2626';
    
    // Update realized PnL with color
    const pnlEl = document.getElementById('strategy-pnl-today');
    const pnl = data.realized_pnl_today || 0;
    pnlEl.textContent = pnl.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
    pnlEl.style.color = pnl >= 0 ? '#16a34a' : '#dc2626';
    
    // Update net PnL display (above open positions table)
    const netPnlEl = document.getElementById('strategy-net-pnl');
    const netPnl = (data.realized_pnl_today || 0) + (data.unrealized_pnl || 0);
    const netPnlSign = netPnl >= 0 ? '+' : '';
    netPnlEl.textContent = netPnlSign + '₹' + netPnl.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
    netPnlEl.style.color = netPnl >= 0 ? '#16a34a' : '#dc2626';
    
    // Update position count badges in position ladder rules
    document.getElementById('p1-badge').textContent = data.p1_count || 0;
    document.getElementById('p2-badge').textContent = data.p2_count || 0;
    document.getElementById('p3-badge').textContent = data.p3_count || 0;
    
    // Update open positions table using sorted render function
    renderStrategyOpenTable(data.open_trades || []);
    
    // Update closed trades table
    const closedTbody = document.getElementById('strategy-closed-tbody');
    if (data.closed_trades_today && data.closed_trades_today.length > 0) {
      closedTbody.innerHTML = data.closed_trades_today.map(t => {
        const pnlColor = (t.pnl || 0) >= 0 ? '#16a34a' : '#dc2626';
        return `<tr>
          <td><span class="badge" style="background:#64748b;color:white;">P${t.position_number}</span></td>
          <td>${t.symbol}</td>
          <td>${formatDateTimeShort(t.entry_time)}</td>
          <td>₹${t.entry_price?.toFixed(2) || '-'}</td>
          <td>${t.exit_time ? formatDateTimeShort(t.exit_time) : '-'}</td>
          <td>₹${t.exit_price?.toFixed(2) || '-'}</td>
          <td>${t.qty}</td>
          <td style="color:${pnlColor};font-weight:600;">₹${t.pnl?.toFixed(2) || '0.00'}</td>
        </tr>`;
      }).join('');
    } else {
      closedTbody.innerHTML = '<tr><td colspan="8" style="text-align:center; color:#94a3b8; padding:20px;">No closed trades today</td></tr>';
    }
  }

  let selectedMode = 'PAPER';  // Track selected mode

  function selectMode(mode) {
    // Optimistically disable buttons while switching
    const btnPaper = document.getElementById('btn-mode-paper');
    const btnLive = document.getElementById('btn-mode-live');
    btnPaper.disabled = true;
    btnLive.disabled = true;

    // Show immediate visual selection while backend switches
    selectedMode = mode;
    applyModeStyles(mode);

    // Call backend to switch runtime mode
    (async () => {
      try {
        const res = await fetch('/api/strategy/mode', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ mode })
        });
        const data = await res.json();
        if (!res.ok) {
          throw new Error(data.error || 'Failed to switch mode');
        }
        // Success - sync selectedMode with server
        selectedMode = data.mode || mode;
        applyModeStyles(selectedMode);
        console.log('Mode switched:', selectedMode, data.db);
        // Refresh strategy status immediately to update UI details
        fetchStrategyStatus();
      } catch (err) {
        console.error('Mode switch failed:', err);
        // Revert styles on failure
        selectedMode = (selectedMode === 'PAPER') ? 'LIVE' : 'PAPER';
        applyModeStyles(selectedMode);
        alert('Mode switch failed: ' + (err.message || err));
      } finally {
        btnPaper.disabled = false;
        btnLive.disabled = false;
      }
    })();
  }

  function applyModeStyles(mode) {
    const btnPaper = document.getElementById('btn-mode-paper');
    const btnLive = document.getElementById('btn-mode-live');
    if (mode === 'PAPER') {
      btnPaper.style.background = '#ef4444';
      btnPaper.style.borderColor = '#ef4444';
      btnPaper.style.color = 'white';
      btnLive.style.background = 'white';
      btnLive.style.borderColor = '#fca5a5';
      btnLive.style.color = '#dc2626';
    } else {
      btnLive.style.background = '#dc2626';
      btnLive.style.borderColor = '#dc2626';
      btnLive.style.color = 'white';
      btnPaper.style.background = 'white';
      btnPaper.style.borderColor = '#fca5a5';
      btnPaper.style.color = '#ef4444';
    }
  }

  async function startStrategy() {
    try {
      const btnStart = document.getElementById('btn-strategy-start');
      btnStart.disabled = true;
      btnStart.textContent = 'Starting...';
      
      const res = await fetch('/api/strategy/momentum/start', { 
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ mode: selectedMode })  // Use selected mode
      });
      const data = await res.json();
      
      if (!res.ok) throw new Error(data.error || 'Failed to start strategy');
      
      // Refresh status
      await fetchStrategyStatus();
      
      // Start polling every 5 seconds (timer runs locally every 1s)
      if (strategyInterval) clearInterval(strategyInterval);
      strategyInterval = setInterval(fetchStrategyStatus, 5000);
      
    } catch (e) {
      alert('Error starting strategy: ' + e.message);
    } finally {
      const btnStart = document.getElementById('btn-strategy-start');
      btnStart.disabled = false;
      btnStart.textContent = '▶ Start Strategy';
    }
  }

  async function stopStrategy() {
    try {
      const ok = window.confirm('Are you sure you want to stop the strategy? Open positions will NOT be closed automatically.');
      if (!ok) return;
      
      const btnStop = document.getElementById('btn-strategy-stop');
      btnStop.disabled = true;
      btnStop.textContent = 'Stopping...';
      
      const res = await fetch('/api/strategy/momentum/stop', { method: 'POST' });
      const data = await res.json();
      
      if (!res.ok) throw new Error(data.error || 'Failed to stop strategy');
      
      // Stop polling and timer
      if (strategyInterval) {
        clearInterval(strategyInterval);
        strategyInterval = null;
      }
      stopTimerCountdown();
      
      // Refresh status
      await fetchStrategyStatus();
      
    } catch (e) {
      alert('Error stopping strategy: ' + e.message);
    } finally {
      const btnStop = document.getElementById('btn-strategy-stop');
      btnStop.disabled = false;
      btnStop.textContent = '■ Stop Strategy';
    }
  }

  async function closeStrategyTrade(tradeId, symbol) {
    try {
      const ok = window.confirm(`Close position in ${symbol}?`);
      if (!ok) return;
      
      const res = await fetch(`/api/strategy/momentum/close/${tradeId}`, { method: 'POST' });
      const data = await res.json();
      
      if (!res.ok) throw new Error(data.error || 'Failed to close trade');
      
      // Refresh status (no alert notification)
      await fetchStrategyStatus();
      
    } catch (e) {
      alert('Error closing trade: ' + e.message);
    }
  }

  async function bookPosition(tradeId, symbol, currentLtp) {
    try {
      const ok = window.confirm(`Book position in ${symbol} at ₹${currentLtp.toFixed(2)}? Current LTP will be set as the target.`);
      if (!ok) return;
      
      const res = await fetch(`/api/strategy/momentum/book/${tradeId}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ target_price: currentLtp })
      });
      const data = await res.json();
      
      if (!res.ok) throw new Error(data.error || 'Failed to book position');
      
      // Refresh status
      await fetchStrategyStatus();
      
    } catch (e) {
      alert('Error booking position: ' + e.message);
    }
  }

  async function clearPosition(tradeId, symbol, currentLtp) {
    try {
      const ok = window.confirm(`Clear position in ${symbol} at ₹${currentLtp.toFixed(2)}? This will close the position and mark it as booked.`);
      if (!ok) return;
      
      const res = await fetch(`/api/strategy/momentum/clear/${tradeId}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ exit_price: currentLtp })
      });
      const data = await res.json();
      
      if (!res.ok) throw new Error(data.error || 'Failed to clear position');
      
      // Refresh status
      await fetchStrategyStatus();
      
    } catch (e) {
      alert('Error clearing position: ' + e.message);
    }
  }

  async function closeAllPositions() {
    try {
      const ok = window.confirm('Are you sure you want to close ALL open positions and reset the strategy? This cannot be undone.');
      if (!ok) return;
      
      const btnCloseAll = document.getElementById('btn-close-all');
      btnCloseAll.disabled = true;
      btnCloseAll.textContent = 'Resetting...';
      
      try {
        // Call the reset endpoint which closes all positions and clears state
        const res = await fetch('/api/strategy/momentum/reset', { method: 'POST' });
        const data = await res.json();
        
        if (res.ok) {
          console.log('Reset response:', data);
          alert(`✓ Strategy Reset Complete!\n\nClosed: ${data.closed} position(s)\nFailed: ${data.failed}\n\nStrategy restarted with zero positions.`);
        } else {
          alert(`✗ Reset Failed: ${data.error}`);
        }
      } catch (e) {
        alert(`Error resetting strategy: ${e.message}`);
      }
      
      // Wait a moment for backend to fully process, then refresh
      console.log('Waiting for backend to process reset...');
      await new Promise(resolve => setTimeout(resolve, 500));
      
      console.log('Fetching updated strategy status...');
      // Refresh status to update UI with cache busting
      const statusRes = await fetch('/api/strategy/momentum/status?t=' + Date.now());
      const statusData = await statusRes.json();
      console.log('Status response:', statusData);
      console.log('Open trades count:', statusData.open_trades?.length || 0);
      
      updateStrategyUI(statusData);
      
    } catch (e) {
      alert('Error resetting strategy: ' + e.message);
    } finally {
      const btnCloseAll = document.getElementById('btn-close-all');
      btnCloseAll.disabled = false;
      btnCloseAll.textContent = '✕ Close All';
    }
  }

  // Start polling when strategy tab is active
  function manageStrategyPolling() {
    const strategyView = document.getElementById('ck-view-strategy');
    if (strategyView && strategyView.style.display !== 'none' && ckActiveSubtab === 'strategy') {
      if (!strategyInterval) {
        strategyInterval = setInterval(fetchStrategyStatus, 5000); // Poll every 5s, timer runs locally
      }
    } else {
      if (strategyInterval) {
        clearInterval(strategyInterval);
        strategyInterval = null;
      }
      // Also stop timer countdown when not on strategy tab
      stopTimerCountdown();
    }
  }

  // ========== END MOMENTUM STRATEGY FUNCTIONS ==========

  // Filters handlers
      document.getElementById('apply-filters').addEventListener('click', ()=> renderFilteredTable());
      document.getElementById('reset-filters').addEventListener('click', ()=>{
        ['f-rank-min','f-rank-max','f-r15-min','f-r15-max','f-rd-min','f-rd-max','f-dd-min','f-dd-max'].forEach(id=>{ const el = document.getElementById(id); if (el) el.value=''; });
        renderFilteredTable();
      });

  // Header Filter button to show filtered view
  const btnShowFiltered = document.getElementById('btn-show-filtered');
  if (btnShowFiltered){ btnShowFiltered.addEventListener('click', ()=> setSelectedTab(tabFiltered, 'view-filtered')); }

  // Place LIMIT buy at 0.1% below LTP with 5% GTT stop-loss for ₹10,000
      async function placeBuy(symbol, btn){
        try{
          if (!symbol) return;
          const ok = window.confirm(`Place BUY (CNC LIMIT) for ${symbol} at 0.1% below LTP with ₹10,000 budget and attach 5% GTT Stop-Loss?`);
          if (!ok) return;
          if (btn){ btn.disabled = true; btn.textContent = 'Placing…'; }
          const res = await fetch('/api/order/buy', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ symbol, budget: 10000, market: false, offset_pct: 0.0005, tsl: true, sl_pct: 0.05 })
          });
          const json = await res.json();
          
          // Handle order placement responses (success and partial success)
          if (res.ok || res.status === 202) {
            const pxMsg = json.limit_price ? `\nLimit: ₹${Number(json.limit_price).toFixed(2)}` : '';
            const gttMsg = json.gtt_id ? `\nGTT SL ID: ${json.gtt_id}` : '';
            const gttStatusMsg = json.gtt_placed ? '\n✓ GTT Placed' : '\n⚠ GTT Failed (see details)';
            const detailedMsg = json.gtt_error ? `\n\nGTT Error: ${json.gtt_error}` : '';
            const confirmMsg = json.message || 'Order placement status unknown';
            
            alert(`${confirmMsg}\n━━━━━━━━━━━━\nSymbol: ${json.symbol}\nQty: ${json.quantity}${pxMsg}\nOrder ID: ${json.order_id}${gttMsg}${gttStatusMsg}${detailedMsg}`);
          } else {
            // Handle order rejection (margin error, market closed, etc.)
            throw new Error(json.error || 'Order placement failed');
          }
        } catch(e){
          alert(`❌ Order Error:\n${e.message || e}`);
        } finally {
          if (btn){ btn.disabled = false; btn.textContent = 'Buy'; }
        }
      }

      fetchLTP();
      setInterval(fetchLTP, 5000);

      // ========== Orders view logic ==========
      let latestOrders = [];
      let sortStateOrders = { key: 'symbol', dir: 'asc' };
      attachSortingFor('orders-table', sortStateOrders, renderOrdersTable);

      function fmtMaybe(v){ return (v==null || Number.isNaN(v)) ? '' : v; }
      function fmtPrice(v){ return (typeof v==='number' && !isNaN(v)) ? v.toFixed(2) : ''; }
      function fmtPct(v){ return (typeof v==='number' && !isNaN(v)) ? v.toFixed(2) + '%' : ''; }
      function pnlColor(v){ if (typeof v!=='number' || isNaN(v)) return ''; return v>=0? 'color: hsl(120,70%,38%);' : 'color:hsl(0,70%,38%);'; }

    async function fetchOrders(){
        try{
          const res = await fetch('/api/orders');
          const json = await res.json();
          if (!res.ok) throw new Error(json.error || 'Failed to fetch orders');
          const arr = (json.orders || []).map(o=>({
            order_id: o.order_id,
            symbol: o.symbol,
            quantity: o.quantity,
            status: o.status,
            avg_price: (typeof o.avg_price==='number')? o.avg_price : (o.avg_price? Number(o.avg_price): null),
            ltp: (typeof o.ltp==='number')? o.ltp : (o.ltp? Number(o.ltp): null),
            trail_trigger: (typeof o.trail_trigger==='number')? o.trail_trigger : (o.trail_trigger? Number(o.trail_trigger): null),
            gtt_stop_price: (typeof o.gtt_stop_price==='number')? o.gtt_stop_price : (o.gtt_stop_price? Number(o.gtt_stop_price): null),
            gtt_stop_pct_from_ltp: (typeof o.gtt_stop_pct_from_ltp==='number')? o.gtt_stop_pct_from_ltp : (o.gtt_stop_pct_from_ltp? Number(o.gtt_stop_pct_from_ltp): null),
            gtt_target_price: (typeof o.gtt_target_price==='number')? o.gtt_target_price : (o.gtt_target_price? Number(o.gtt_target_price): null),
            gtt_target_pct_from_ltp: (typeof o.gtt_target_pct_from_ltp==='number')? o.gtt_target_pct_from_ltp : (o.gtt_target_pct_from_ltp? Number(o.gtt_target_pct_from_ltp): null),
            pnl: (typeof o.pnl==='number')? o.pnl : (o.pnl? Number(o.pnl): null),
            pnl_pct: (typeof o.pnl_pct==='number')? o.pnl_pct : (o.pnl_pct? Number(o.pnl_pct): null),
            gtt_id: o.gtt_id || ''
          }));
          latestOrders = arr;
          document.getElementById('orders-meta').textContent = `(${arr.length})`;
          renderOrdersTable();
      // also fetch consolidated snapshots
      await fetchOrdersSnapshot();
        }catch(e){
          document.getElementById('orders-meta').textContent = '(error)';
        }
      }

      function renderOrdersTable(){
        const tbody = document.querySelector('#orders-table tbody');
        const rows = latestOrders.slice();
        applySort(rows, sortStateOrders);
        tbody.innerHTML = '';
        let totalPnlSum = 0;
        for (const r of rows){
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${r.symbol||''}</td>
            <td>${fmtMaybe(r.quantity)}</td>
            <td>${r.status||''}</td>
            <td>${fmtPrice(r.avg_price)}</td>
            <td>${fmtPrice(r.ltp)}</td>
            <td>${fmtPrice(r.trail_trigger)}</td>
            <td>${fmtPrice(r.gtt_stop_price)}</td>
            <td>${fmtPct(r.gtt_stop_pct_from_ltp)}</td>
            <td>${fmtPrice(r.gtt_target_price)}</td>
            <td>${fmtPct(r.gtt_target_pct_from_ltp)}</td>
            <td><span class="num" style="${pnlColor(r.pnl)}">${fmtPrice(r.pnl)}</span></td>
            <td><span class="num" style="${pnlColor(r.pnl)}">${fmtPct(r.pnl_pct)}</span></td>
            <td>${r.order_id||''}</td>
            <td>${r.gtt_id||''}</td>
            <td>
              ${r.order_id? `<button class="btn small" onclick="cancelOrder('${r.order_id}', this)">Cancel</button>` : ''}
              ${r.gtt_id? `<button class="btn small secondary" onclick="cancelGTT('${r.gtt_id}', '${r.symbol}', this)" style="margin-left:6px;">Cancel GTT</button>` : ''}
            </td>
            <td><span class="num" style="${pnlColor(r.pnl)}">${fmtPrice(r.pnl)}</span></td>
          `;
          tbody.appendChild(tr);
          if (typeof r.pnl === 'number' && !Number.isNaN(r.pnl)) totalPnlSum += r.pnl;
        }
        const totalEl = document.getElementById('orders-total-pnl');
        const totalCell = document.getElementById('orders-total-pnl-cell');
        const color = totalPnlSum >= 0 ? 'hsl(120,70%,38%)' : 'hsl(0,70%,38%)';
        if (totalEl){
          totalEl.style.color = color;
          totalEl.textContent = `Total Orders PnL: ₹${Number(totalPnlSum).toFixed(2)}`;
        }
        if (totalCell){
          totalCell.style.color = color;
          totalCell.textContent = `${Number(totalPnlSum).toFixed(2)}`;
        }
      }

      document.getElementById('btn-refresh-orders').addEventListener('click', fetchOrders);
      setInterval(()=>{
        if (document.getElementById('view-orders').style.display==='block') fetchOrders();
      }, 5000);

      // ========== Trade Journal Logic ==========
      let latestTrades = [];
      let sortStateTrades = { key: 'entry_date', dir: 'desc' };

      async function syncTradeExits(){
        try{
          const res = await fetch('/api/trade-journal/sync-exits', {method: 'POST'});
          const json = await res.json();
          if (res.ok && json.synced_count > 0){
            console.log(`Synced ${json.synced_count} trade exits`);
            // Refresh trades to show updated exits
            await fetchTrades();
          }
        }catch(e){
          console.error('Exit sync error:', e);
        }
      }

      async function fetchTrades(){
        try{
          const res = await fetch('/api/trades');
          const json = await res.json();
          if (!res.ok) throw new Error(json.error || 'Failed to fetch trades');
          const arr = (json.trades || []).map(t=>({
            symbol: t.symbol || t.tradingsymbol || '',
            entry_date: t.entry_date || t.created_at || '',
            entry_price: (typeof t.entry_price==='number')? t.entry_price : (t.entry_price? Number(t.entry_price): null),
            entry_qty: (typeof t.entry_qty==='number')? t.entry_qty : (t.qty? Number(t.qty): (t.quantity ? Number(t.quantity) : null)),
            exit_date: t.exit_date || t.closed_at || '',
            exit_price: (typeof t.exit_price==='number')? t.exit_price : (t.exit_price? Number(t.exit_price): null),
            pnl: (typeof t.pnl==='number')? t.pnl : (t.pnl? Number(t.pnl): null),
            pnl_pct: (typeof t.pnl_pct==='number')? t.pnl_pct : (t.pnl_pct? Number(t.pnl_pct): null),
            duration: t.duration || calculateDuration(t.entry_date || t.created_at, t.exit_date || t.closed_at) || '',
            strategy: t.strategy || t.signal || '',
            status: t.status || 'closed',
            notes: t.notes || ''
          }));
          latestTrades = arr;
          document.getElementById('trades-meta').textContent = `(${arr.length})`;
          renderTradesTable();
          calculateTradesSummary();
        }catch(e){
          const tbody = document.querySelector('#trades-table tbody');
          if (tbody) tbody.innerHTML = `<tr><td colspan="12" class="muted">${escapeHtml(e.message)}</td></tr>`;
          document.getElementById('trades-meta').textContent = '(error)';
        }
      }

      function calculateDuration(startStr, endStr){
        if (!startStr || !endStr) return null;
        try {
          const start = new Date(startStr);
          const end = new Date(endStr);
          if (isNaN(start) || isNaN(end)) return null;
          const diffMs = end - start;
          const diffHrs = diffMs / (1000 * 60 * 60);
          return Math.round(diffHrs * 10) / 10; // 1 decimal place
        } catch (e) {
          return null;
        }
      }

      function renderTradesTable(){
        const tbody = document.querySelector('#trades-table tbody');
        const filtered = applyTradesFilter(latestTrades);
        applySort(filtered, sortStateTrades);
        tbody.innerHTML = '';
        for (const t of filtered){
          const tr = document.createElement('tr');
          const entryDate = t.entry_date ? new Date(t.entry_date).toLocaleDateString() : '';
          const exitDate = t.exit_date ? new Date(t.exit_date).toLocaleDateString() : '';
          tr.innerHTML = `
            <td>${t.symbol||''}</td>
            <td>${entryDate}</td>
            <td>${fmtPrice(t.entry_price)}</td>
            <td>${fmtMaybe(t.entry_qty)}</td>
            <td>${exitDate}</td>
            <td>${fmtPrice(t.exit_price)}</td>
            <td><span class="num" style="${pnlColor(t.pnl)}">${fmtPrice(t.pnl)}</span></td>
            <td><span class="num" style="${pnlColor(t.pnl_pct)}">${fmtPct(t.pnl_pct)}</span></td>
            <td>${fmtMaybe(t.duration)}</td>
            <td>${t.strategy||''}</td>
            <td>${t.status||''}</td>
            <td>${t.notes||''}</td>
          `;
          tbody.appendChild(tr);
        }
      }

      function applyTradesFilter(trades){
        const symbol = document.getElementById('tj-filter-symbol').value.trim().toUpperCase();
        const dateFrom = document.getElementById('tj-filter-date-from').value;
        const dateTo = document.getElementById('tj-filter-date-to').value;
        
        return trades.filter(t=>{
          if (symbol && t.symbol && !t.symbol.toUpperCase().includes(symbol)) return false;
          if (dateFrom){
            const tDate = t.entry_date ? new Date(t.entry_date).toISOString().split('T')[0] : '';
            if (tDate < dateFrom) return false;
          }
          if (dateTo){
            const tDate = t.entry_date ? new Date(t.entry_date).toISOString().split('T')[0] : '';
            if (tDate > dateTo) return false;
          }
          return true;
        });
      }

      function calculateTradesSummary(){
        const filtered = applyTradesFilter(latestTrades);
        if (filtered.length === 0){
          document.getElementById('trades-winrate').textContent = '-';
          document.getElementById('trades-avg-win').textContent = '-';
          document.getElementById('trades-avg-loss').textContent = '-';
          document.getElementById('trades-profit-factor').textContent = '-';
          document.getElementById('trades-total-pnl-cell').textContent = '₹0.00';
          document.getElementById('trades-total-pnl-pct-cell').textContent = '0.00%';
          return;
        }

        let totalPnl = 0;
        let winCount = 0;
        let lossCount = 0;
        let totalWin = 0;
        let totalLoss = 0;

        for (const t of filtered){
          const pnl = typeof t.pnl === 'number' ? t.pnl : 0;
          totalPnl += pnl;
          if (pnl > 0){
            winCount++;
            totalWin += pnl;
          } else if (pnl < 0){
            lossCount++;
            totalLoss += Math.abs(pnl);
          }
        }

        const winRate = filtered.length > 0 ? ((winCount / filtered.length) * 100) : 0;
        const avgWin = winCount > 0 ? (totalWin / winCount) : 0;
        const avgLoss = lossCount > 0 ? (totalLoss / lossCount) : 0;
        const profitFactor = totalLoss > 0 ? (totalWin / totalLoss) : (totalWin > 0 ? Infinity : 0);

        document.getElementById('trades-winrate').textContent = `${winRate.toFixed(1)}%`;
        document.getElementById('trades-avg-win').textContent = `₹${avgWin.toFixed(2)}`;
        document.getElementById('trades-avg-loss').textContent = `₹${avgLoss.toFixed(2)}`;
        document.getElementById('trades-profit-factor').textContent = profitFactor === Infinity ? '∞' : profitFactor.toFixed(2);
        
        const totalColor = totalPnl >= 0 ? 'hsl(120,70%,38%)' : 'hsl(0,70%,38%)';
        document.getElementById('trades-total-pnl-cell').textContent = `${totalPnl.toFixed(2)}`;
        document.getElementById('trades-total-pnl-cell').style.color = totalColor;
        
        // Calculate average return percentage
        let totalReturnPct = 0;
        for (const t of filtered){
          if (typeof t.pnl_pct === 'number') totalReturnPct += t.pnl_pct;
        }
        const avgReturnPct = filtered.length > 0 ? (totalReturnPct / filtered.length) : 0;
        document.getElementById('trades-total-pnl-pct-cell').textContent = `${avgReturnPct.toFixed(2)}%`;
        document.getElementById('trades-total-pnl-pct-cell').style.color = totalColor;
      }

      function exportTradesCSV(){
        const filtered = applyTradesFilter(latestTrades);
        if (filtered.length === 0){
          alert('No trades to export');
          return;
        }

        const headers = ['Symbol', 'Entry Date', 'Entry Price', 'Qty', 'Exit Date', 'Exit Price', 'PnL (₹)', 'PnL %', 'Duration (hrs)', 'Strategy', 'Status', 'Notes'];
        const rows = filtered.map(t=>[
          t.symbol,
          t.entry_date,
          t.entry_price || '',
          t.entry_qty || '',
          t.exit_date,
          t.exit_price || '',
          t.pnl || '',
          t.pnl_pct || '',
          t.duration || '',
          t.strategy,
          t.status,
          t.notes
        ]);

        const csv = [headers.join(','), ...rows.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(','))].join('\n');
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `trades_${new Date().toISOString().split('T')[0]}.csv`;
        a.click();
        URL.revokeObjectURL(url);
      }

      // Trade Journal event listeners
      document.getElementById('btn-refresh-trades').addEventListener('click', fetchTrades);
      document.getElementById('btn-sync-exits').addEventListener('click', syncTradeExits);
      document.getElementById('btn-export-trades').addEventListener('click', exportTradesCSV);
      document.getElementById('tj-apply-filters').addEventListener('click', ()=>{
        renderTradesTable();
        calculateTradesSummary();
      });
      document.getElementById('tj-reset-filters').addEventListener('click', ()=>{
        document.getElementById('tj-filter-symbol').value = '';
        document.getElementById('tj-filter-date-from').value = '';
        document.getElementById('tj-filter-date-to').value = '';
        renderTradesTable();
        calculateTradesSummary();
      });
      
      // Auto-sync exits every 30 seconds
      setInterval(syncTradeExits, 30000);
      
      // Attach sorting for trades table
      attachSortingFor('trades-table', sortStateTrades, ()=>{
        renderTradesTable();
        calculateTradesSummary();
      });

      // Active orderbook logic (broker active orders + GTTs)
      async function fetchActiveOrderbook(){
        try{
          const [obRes, gttRes, ltpRes] = await Promise.all([fetch('/api/orderbook'), fetch('/api/gtt'), fetch('/api/ltp')]);
          const obJson = await obRes.json();
          const gttJson = await gttRes.json();
          const ltpJson = ltpRes.ok ? await ltpRes.json() : {};
          if (!obRes.ok) throw new Error(obJson.error || 'Orderbook fetch failed');
          if (!gttRes.ok) throw new Error(gttJson.error || 'GTT fetch failed');
          const ltpData = ltpJson.data || {};
          renderActiveOrdersWithSort(obJson.orders || [], ltpData);
          renderActiveGTTsWithSort(gttJson.items || gttJson.gtts || gttJson || [], ltpData);
        }catch(e){
          const tbody = document.querySelector('#active-orders-table tbody'); if (tbody) tbody.innerHTML = `<tr><td colspan="8" class="muted">${escapeHtml(e.message)}</td></tr>`;
          const gtbody = document.querySelector('#active-gtt-table tbody'); if (gtbody) gtbody.innerHTML = `<tr><td colspan="9" class="muted">${escapeHtml(e.message)}</td></tr>`;
        }
      }

      // Start trailing for an existing GTT
      async function startTrailing(symbol, gttId, qty, stopPrice, gttType, targetPrice, btn) {
        try {
          if (!symbol || !gttId) return;
          if (btn) { btn.disabled = true; btn.textContent = 'Starting…'; }
          const res = await fetch('/api/trailing/start', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
              symbol: symbol,
              gtt_id: gttId,
              qty: parseInt(qty),
              stop_price: parseFloat(stopPrice),
              gtt_type: gttType,
              target_price: targetPrice ? parseFloat(targetPrice) : null
            })
          });
          const j = await res.json();
          if (!res.ok) throw new Error(j.error || 'Failed to start trailing');
          alert(`Trailing started for ${symbol}`);
          if (btn) { btn.textContent = 'Trailing'; btn.classList.add('active'); }
        } catch(e) {
          alert(`Error: ${e.message || e}`);
          if (btn) { btn.disabled = false; btn.textContent = 'Trail'; }
        }
      }

      document.getElementById('btn-refresh-active').addEventListener('click', fetchActiveOrderbook);
      setInterval(()=>{ if (document.getElementById('view-active').style.display==='block') fetchActiveOrderbook(); }, 5000);

      // Cancel order/GTT handlers
      async function cancelOrder(orderId, symbol, btn){
        try{
          if (!orderId) return;
          // Ensure orderId is a string and trim whitespace
          const cleanOrderId = String(orderId).trim();
          if (!cleanOrderId) return;
          const cleanSymbol = (typeof symbol === 'string') ? String(symbol).trim() : '';
          const confirmMsg = cleanSymbol ? `Cancel order ${cleanOrderId} for ${cleanSymbol}?` : `Cancel order ${cleanOrderId}?`;
          if (!confirm(confirmMsg)) return;
          if (btn) { btn.disabled = true; btn.textContent = 'Cancelling…'; }
          const res = await fetch('/api/order/cancel', {
            method: 'POST', 
            headers: {'Content-Type':'application/json'}, 
            body: JSON.stringify({order_id: cleanOrderId, symbol: cleanSymbol})
          });
          const j = await res.json();
          if (!res.ok) throw new Error(j.error || `Cancel failed: ${res.status}`);
          const linkedGTTMsg = j.linked_gtt_cancelled ? ` (also cancelled linked GTT #${j.linked_gtt_id})` : '';
          alert(`Cancelled order ${cleanOrderId}${linkedGTTMsg}`);
          // Refresh both orders and holdings
          fetchOrders();
          fetchActiveOrderbook();
        }catch(e){
          console.error('Order cancel error:', e);
          alert(`Cancel error: ${e.message||e}`);
        }finally{ if (btn){ btn.disabled = false; btn.textContent = 'Cancel'; } }
      }

      // Book profit: set target to current LTP, keep stop same
      async function bookGTT(gttId, symbol, qty, stopPrice, ltp, btn){
        try{
          if (!gttId || !symbol || ltp === undefined || ltp === null || ltp === '') return;
          const cleanGttId = String(gttId).trim();
          if (!cleanGttId) return;
          
          // Convert to numbers
          const ltpNum = parseFloat(ltp);
          const stopNum = parseFloat(stopPrice);
          
          if (isNaN(ltpNum) || isNaN(stopNum)) {
            alert('Invalid LTP or Stop price');
            return;
          }
          
          if (!confirm(`Book profit for ${symbol}? Target will be set to current LTP (${ltpNum.toFixed(2)}), Stop will remain at ${stopNum.toFixed(2)}`)) return;
          if (btn) { btn.disabled = true; btn.textContent = 'Booking…'; }
          const res = await fetch('/api/gtt/book', { 
            method: 'POST', 
            headers: {'Content-Type':'application/json'}, 
            body: JSON.stringify({
              gtt_id: cleanGttId,
              symbol: symbol,
              qty: parseInt(qty),
              stop_price: stopNum,
              target_price: ltpNum
            }) 
          });
          const j = await res.json();
          if (!res.ok) throw new Error(j.error || `Book GTT failed: ${res.status}`);
          alert(`Booked GTT ${cleanGttId} for ${symbol}. Target set to ${ltpNum.toFixed(2)}, Stop at ${stopNum.toFixed(2)}`);
          fetchActiveOrderbook();
        }catch(e){
          console.error('GTT book error:', e);
          alert(`Book GTT error: ${e.message||e}`);
        }finally{ if (btn){ btn.disabled = false; btn.textContent = 'Book'; } }
      }

      async function cancelGTT(gttId, symbol, btn){
        try{
          if (!gttId) return;
          // Ensure gttId is a string and trim whitespace
          const cleanGttId = String(gttId).trim();
          if (!cleanGttId) return;
          if (!confirm(`Cancel GTT ${cleanGttId} for ${symbol || ''}?`)) return;
          if (btn) { btn.disabled = true; btn.textContent = 'Cancelling…'; }
          const res = await fetch('/api/gtt/cancel', { 
            method: 'POST', 
            headers: {'Content-Type':'application/json'}, 
            body: JSON.stringify({gtt_id: cleanGttId}) 
          });
          const j = await res.json();
          if (!res.ok) throw new Error(j.error || `GTT cancel failed: ${res.status}`);
          alert(`Cancelled GTT ${cleanGttId} for ${symbol}`);
          // Refresh both orders and holdings
          fetchOrders();
          fetchActiveOrderbook();
        }catch(e){
          console.error('GTT cancel error:', e);
          alert(`Cancel GTT error: ${e.message||e}`);
        }finally{ if (btn){ btn.disabled = false; btn.textContent = 'Cancel GTT'; } }
      }

      // ---------- Consolidated snapshot (holdings/positions/orderbook/trades/gtt) ----------
      async function fetchJSON(path){ const r = await fetch(path); const j = await r.json(); if (!r.ok) throw new Error(j.error||`Failed: ${path}`); return j; }
      function num(v){ return (typeof v==='number')? v : (v!=null? Number(v) : null); }
      async function fetchOrdersSnapshot(){
  // uses global snapshot controls state
        try{
          const [hold, pos, ob, trades] = await Promise.all([
            fetchJSON('/api/holdings'),
            fetchJSON('/api/positions'),
            fetchJSON('/api/orderbook'),
            fetchJSON('/api/trades'),
          ]);
          const holdings = (hold.holdings||[]).reduce((m,h)=>{ if (h.tradingsymbol) m[h.tradingsymbol] = h; return m; },{});
          const posNet = ((pos.net)||[]).reduce((m,p)=>{ if (p.tradingsymbol) m[p.tradingsymbol] = p; return m; },{});
          const activeBySym = (ob.orders||[]).reduce((m,o)=>{ const s=o.tradingsymbol||o.symbol; if(!s) return m; m[s] = (m[s]||0)+1; return m; },{});
          const tradesBySym = (trades.trades||[]).reduce((m,t)=>{ const s=t.tradingsymbol||t.symbol; if(!s) return m; m[s] = (m[s]||0)+1; return m; },{});
          const gttBySymbol = trades.gtt_by_symbol||{}; // built server-side
          const symbols = new Set([
            ...Object.keys(holdings),
            ...Object.keys(posNet),
            ...Object.keys(activeBySym),
            ...Object.keys(tradesBySym),
            ...Object.keys(gttBySymbol),
            ...latestOrders.map(o=>o.symbol).filter(Boolean),
          ]);
          const rows = [];
          symbols.forEach(s=>{
            const h = holdings[s]||{};
            const p = posNet[s]||{};
            const g = gttBySymbol[s]||{ count:0, items:[] };
            // Prefer server-calculated totals which may include T+1/pending quantities
            const hQty = (typeof h.total_quantity === 'number') ? num(h.total_quantity) : num(h.quantity);
            const hAvg = num(h.average_price||h.average);
            const hLtp = num(h.last_price);
            const holdPnl = num(h.holding_pnl);
            const t1Qty = (typeof h.t1_quantity === 'number') ? num(h.t1_quantity) : 0;
            const posQty = num(p.quantity);
            const posDayPnl = num(p.pnl||p.day_pnl||p.m2m);
            // Use server-provided totals if available, else compute client-side
            const totalAmount = (h.total_amount != null) ? num(h.total_amount) : ((typeof hQty==='number' && typeof hLtp==='number') ? (hQty * hLtp) : null);
            const totalHoldings = (h.total_holdings_amount != null) ? num(h.total_holdings_amount) : ((typeof hQty==='number' && typeof hAvg==='number') ? (hQty * hAvg) : null);
            const totalStockPnl = ((typeof holdPnl==='number'? holdPnl:0) + (typeof posDayPnl==='number'? posDayPnl:0));
            rows.push({
              symbol: s,
              total_holdings: totalHoldings,
              total_amount: totalAmount,
              holding_qty: hQty,
              holding_avg: hAvg,
              holding_ltp: hLtp,
              holding_pnl: holdPnl, // show holdings-only PnL (exclude position day PnL)
              holding_pnl_pct: num(h.holding_pnl_pct),
              t1_quantity: t1Qty,
              position_qty: posQty,
              position_pnl_day: posDayPnl,
              active_orders: activeBySym[s]||0,
              trades_count: tradesBySym[s]||0,
              gtt_count: g.count||0,
              gtt_triggers: (g.items||[]).map(it=> (Array.isArray(it.trigger_values)? it.trigger_values.join('/') : '') ).join(', ')
            });
          });
          // Compute total Positional PnL across rows
          // Totals are shown in the table summary row; header summary removed.
          renderOrdersSnapshot(rows);
        }catch(e){
          const tbody = document.querySelector('#orders-snapshot tbody');
          if (tbody) tbody.innerHTML = `<tr><td colspan="9" class="muted">${escapeHtml(e.message)}</td></tr>`;
          // Header summary removed; nothing to clear here.
        }
      }
  // Snapshot sort state and header sorting
  let sortStateSnapshot = { key: 'symbol', dir: 'asc' };
  attachSortingFor('orders-snapshot', sortStateSnapshot, ()=> fetchOrdersSnapshot());

      function renderOrdersSnapshot(rows){
        const tbody = document.querySelector('#orders-snapshot tbody');
        tbody.innerHTML = '';
        // Compute combined for sorting if needed
        rows.forEach(r=>{ r.combined_pnl = ((typeof r.position_pnl_day==='number'? r.position_pnl_day:0) + (typeof r.holding_pnl==='number'? r.holding_pnl:0)); });
        // Apply header-based sort
        const key = sortStateSnapshot.key;
        const dir = sortStateSnapshot.dir;
        const filtered = rows.slice();
        filtered.sort((a,b)=>{
          const va = a[key];
          const vb = b[key];
          if (va == null && vb == null) return 0;
          if (va == null) return 1;
          if (vb == null) return -1;
          if (typeof va === 'number' && typeof vb === 'number') return dir==='asc'? va - vb : vb - va;
          return dir==='asc'? String(va).localeCompare(String(vb)) : String(vb).localeCompare(String(va));
        });
  let sum = 0;
  let sumHold = 0;
  let sumTotalAmount = 0;
  let sumTotalHoldings = 0;
        for(const r of filtered){
          const combined = (typeof r.position_pnl_day==='number'? r.position_pnl_day:0) + (typeof r.holding_pnl==='number'? r.holding_pnl:0);
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${r.symbol||''}</td>
            <td>${fmtPrice(r.total_holdings)}${(typeof r.t1_quantity==='number' && r.t1_quantity>0)? ` <span class="muted">| T+1: ${r.t1_quantity}</span>` : ''}</td>
            <td>${fmtPrice(r.total_amount)}</td>
            <td>${fmtMaybe(r.holding_qty)}</td>
            <td>${fmtPrice(r.holding_avg)}</td>
            <td>${fmtPrice(r.holding_ltp)}</td>
            <td><span class="num" style="${pnlColor(r.holding_pnl)}">${fmtPrice(r.holding_pnl)}</span></td>
            <td>${fmtMaybe(r.position_qty)}</td>
            <td><span class="num" style="${pnlColor(r.position_pnl_day)}">${fmtPrice(r.position_pnl_day)}</span></td>
            <td>${r.active_orders||0}</td>
            <td>${r.trades_count||0}</td>
            <td>${r.gtt_count||0}</td>
            <td>${r.gtt_triggers||''}</td>
            <td><span class="num" style="${pnlColor(combined)}">${fmtPrice(combined)}</span></td>
          `;
          tbody.appendChild(tr);
          if (typeof r.position_pnl_day === 'number' && !Number.isNaN(r.position_pnl_day)) sum += r.position_pnl_day;
          // holding_pnl now represents total PnL for the stock; for totals, still show split:
          const holdOnly = (typeof r.holding_qty==='number' && typeof r.holding_avg==='number' && typeof r.holding_ltp==='number')
            ? ((r.holding_ltp - r.holding_avg) * r.holding_qty) : null;
          if (typeof holdOnly === 'number' && !Number.isNaN(holdOnly)) sumHold += holdOnly;
          if (typeof r.total_amount === 'number' && !Number.isNaN(r.total_amount)) sumTotalAmount += r.total_amount;
          if (typeof r.total_holdings === 'number' && !Number.isNaN(r.total_holdings)) sumTotalHoldings += r.total_holdings;
        }
        // Separator row
        const sepTr = document.createElement('tr');
        sepTr.innerHTML = '<td colspan="14" style="height:6px; background:transparent"></td>';
        tbody.appendChild(sepTr);
        // Totals row: create per-column totals so numbers appear under their columns
        const totalsTr = document.createElement('tr');
        const totalColor = (sum + sumHold) >= 0 ? 'hsl(120,70%,38%)' : 'hsl(0,70%,38%)';
        // Build 14 cells aligning with table columns
        const cells = new Array(14).fill('');
        // Column indexes (0-based): 1=total_holdings,2=total_amount,6=holding_pnl,8=position_pnl_day,13=combined_pnl
        cells[1] = `<span class="num" style="font-weight:600; color:${totalColor};">${fmtPrice(sumTotalHoldings)}</span>`;
        cells[2] = `<span class="num" style="font-weight:600; color:${totalColor};">${fmtPrice(sumTotalAmount)}</span>`;
        cells[6] = `<span class="num" style="font-weight:600; color:${totalColor};">${fmtPrice(sumHold)}</span>`;
        cells[8] = `<span class="num" style="font-weight:600; color:${totalColor};">${fmtPrice(sum)}</span>`;
        cells[13] = `<span class="num" style="font-weight:600; color:${totalColor};">${fmtPrice(sum + sumHold)}</span>`;
        totalsTr.innerHTML = cells.map(c=>`<td>${c}</td>`).join('');
        tbody.appendChild(totalsTr);
      }
      
      // Initialize strategy parameters on page load
      fetchStrategyParameters();
    </script>
  </body>
</html>
